# Epic 10 Retrospective

**Date**: 2026-01-07
**Epic**: Epic 10 - System Utilities (Import, Export, Dashboard, Audit, Holidays, Backup)
**Stories Completed**: 6 (10.1, 10.2, 10.3, 10.4, 10.5, 10.6)
**Review Type**: Adversarial Code Review

---

## Executive Summary

Epic 10 implemented 6 critical system utility stories covering import/export, dashboard monitoring, audit log viewer, holiday management, and database restore functionality. The code review revealed **12 distinct issues** with **7 being Epic 9 retro violations** (type safety issues).

**Overall Assessment**: The code is functional and follows many good patterns, but has consistent type safety violations that contradict Epic 9 learnings. One critical SQL injection pattern was identified.

---

## Stories Delivered

| Story | Title | Status |
|-------|-------|--------|
| 10.1 | Import Excel (Users, Proposals) | Complete |
| 10.2 | Export Excel (Full Dump) | Complete |
| 10.3 | System Health Dashboard | Complete |
| 10.4 | Full Audit Log Viewer | Complete |
| 10.5 | Holiday Management (Full CRUD) | Complete |
| 10.6 | DB Restore + State Recompute | Complete |

---

## What Went Well

### 1. Proper Interface Definitions
Most services properly define interfaces for return types and data structures:
- `PaginatedHolidays` interface in holidays.service.ts
- `FullExportResult` interface in full-dump-export.service.ts
- `BulkRemindResult` interface in notifications.service.ts
- `BulkAssignResult` interface in bulk-operations.service.ts

### 2. Consistent Audit Logging
All modules properly log audit events with meaningful metadata:
```typescript
await this.auditService.logEvent({
  action: AuditAction.HOLIDAY_CREATE,
  actorUserId: userId,
  entityType: 'Holiday',
  entityId: holiday.id,
  metadata: { date, name, recurring },
});
```

### 3. Vietnamese Localization
Excel export and import properly handle Vietnamese text:
- Vietnamese headers in Excel templates
- Role and state mapping from Vietnamese labels
- Vietnamese error messages

### 4. Clean Epic 8 Implementation
The `bulk-operations` and `notifications` modules (Epic 8 stories 8.1, 8.2) followed Epic 7 retro patterns properly with no type violations.

---

## What Went Wrong

### 1. Epic 9 Retro Violations (Type Safety)

**Pattern**: Despite Epic 9 explicitly banning `as unknown` and `as any` casts, these patterns appear throughout Epic 10.

#### Issue 1.1: `as unknown as Record<string, unknown>`
**Files**: `import.service.ts:106, 126, 149, 260`

```typescript
// BAD - Epic 9 violation
const userData = rowData as unknown as Record<string, unknown>;
```

**Fix**: Define proper interface:
```typescript
interface ExcelRowData {
  email?: string;
  displayName?: string;
  role?: string;
  facultyId?: string;
}
const userData: Partial<ExcelRowData> = { ... };
```

#### Issue 1.2: `as any` for WorkflowAction
**File**: `import.service.ts:327`

```typescript
// BAD
action: WorkflowAction.CREATE as any,
```

**Fix**: Direct enum usage (already valid):
```typescript
action: WorkflowAction.CREATE,
```

#### Issue 1.3: `(body as any)` for Context Fields
**File**: `import.controller.ts:161-163, 245-247`

```typescript
// BAD
const ip = (body as any).ip;
const userAgent = (body as any).userAgent;
const requestId = (body as any).requestId;
```

**Fix**: Create proper interface:
```typescript
interface AuditContextDto extends ExportExcelDto {
  ip?: string;
  userAgent?: string;
  requestId?: string;
}
```

#### Issue 1.4: `as any` for Header Value Check
**File**: `excel-parser.service.ts:115, 192`

```typescript
// BAD
if (Object.values(this.USER_IMPORT_HEADERS).includes(cellValue as any)) {
```

**Fix**: Use type assertion:
```typescript
const headerValues = Object.values(this.USER_IMPORT_HEADERS) as string[];
if (headerValues.includes(cellValue)) {
```

#### Issue 1.5: Missing AuditAction Enum Values
**File**: `backup.service.ts:143, 167, 210, 319, 337`

```typescript
// BAD - These actions don't exist in AuditAction enum
action: 'BACKUP_UPLOAD' as any,
action: 'RESTORE_STARTED' as any,
```

**Fix**: Add to AuditAction enum:
```typescript
// audit-action.enum.ts
export enum AuditAction {
  // ... existing actions
  BACKUP_UPLOAD = 'BACKUP_UPLOAD',
  BACKUP_DELETE = 'BACKUP_DELETE',
  RESTORE_STARTED = 'RESTORE_STARTED',
  RESTORE_COMPLETED = 'RESTORE_COMPLETED',
  RESTORE_FAILED = 'RESTORE_FAILED',
}
```

#### Issue 1.6: JSON Field Type Cast
**File**: `audit.service.ts:73`

```typescript
// BAD
metadata: (dto.metadata || null) as unknown as Prisma.NullableJsonNullValueInput,
```

**Fix**: Use Prisma's proper typing:
```typescript
metadata: dto.metadata ?? Prisma.JsonNull,
```

#### Issue 1.7: Object Cast for Where Clause
**File**: `audit.service.ts:139, 145`

```typescript
// BAD
where.occurredAt = {
  ...where.occurredAt as object,
  gte: new Date(from_date),
};
```

**Fix**: Proper type narrowing:
```typescript
const occurredAt: Prisma.DateTimeFilter | undefined = where.occurredAt as any;
where.occurredAt = {
  ...occurredAt,
  gte: new Date(from_date),
} as any;
```

Or better, build the whole object at once.

---

### 2. Security Concerns

#### Issue 2.1: SQL Injection Risk Pattern
**File**: `holidays.service.ts:94-97, 103-105`

```typescript
// CRITICAL - SQL injection pattern
${query.year ? `AND date >= ${startOfYear.toISOString()} AND date <= ${endOfYear.toISOString()}` : ''}
${query.recurring !== undefined ? `AND recurring = ${query.recurring}` : ''}
```

While the current implementation is safe (dates are formatted strings, booleans are literals), this pattern is dangerous for future maintenance.

**Fix**: Use parameterized queries or Prisma:
```typescript
// Option 1: Use Prisma (recommended)
const holidays = await this.prisma.businessCalendar.findMany({
  where: {
    isHoliday: true,
    ...(query.year && {
      date: {
        gte: startOfYear,
        lte: endOfYear,
      },
    }),
    ...(query.recurring !== undefined && { recurring: query.recurring }),
  },
});

// Option 2: Parameterized query template
const holidays = await this.prisma.$queryRaw<Array<HolidayRow>>`
  SELECT id, date, name, recurring, created_at, updated_at
  FROM business_calendar
  WHERE is_holiday = true
    ${query.year ? Prisma.sql`AND date >= ${startOfYear} AND date <= ${endOfYear}` : Prisma.empty}
    ${query.recurring !== undefined ? Prisma.sql`AND recurring = ${query.recurring}` : Prisma.empty}
  ORDER BY date ASC
  LIMIT ${pageSize} OFFSET ${skip}
`;
```

---

### 3. Design Issues

#### Issue 3.1: Raw SQL Instead of Prisma
**File**: `holidays.service.ts`

The holidays module uses `$queryRaw` for queries that Prisma can handle natively. This adds complexity and maintenance burden.

#### Issue 3.2: Hardcoded Backup Path
**File**: `backup.service.ts:50`

```typescript
private readonly backupsDir = '/tmp/backups';
```

This should be configurable via environment variable.

#### Issue 3.3: Placeholder Health Metrics
**File**: `health.service.ts`

Many health metrics return placeholder values that don't provide actual monitoring:
- Connection pool: hardcoded `{ active: 1, idle: 4, total: 5, max: 10 }`
- Background jobs: always returns `{ status: 'idle', activeJobs: 0, ... }`
- Disk usage: always returns `'Unknown'`

Either implement real metrics or clearly document as placeholders.

---

## Metrics

| Metric | Value |
|--------|-------|
| Total Files Reviewed | 15 |
| Lines of Code | ~4,500 |
| Epic 9 Retro Violations | 7 |
| Security Issues | 1 (pattern) |
| Design Issues | 3 |
| Test Coverage | Not assessed |

---

## Action Items for Epic 11

### Must Fix (Blocking)
1. [ ] Add missing AuditAction enum values for backup operations
2. [ ] Fix SQL injection pattern in holidays.service.ts
3. [ ] Replace `as any` casts in import module with proper interfaces

### Should Fix (Quality)
4. [ ] Replace raw SQL in holidays with Prisma queries
5. [ ] Make backup path configurable
6. [ ] Fix `as unknown` casts in import.service.ts
7. [ ] Fix `as object` casts in audit.service.ts

### Could Fix (Nice to Have)
8. [ ] Implement real health metrics or document placeholders
9. [ ] Add proper context interface for audit decorators
10. [ ] Consider using interceptor for audit context instead of @Body decorators

---

## Lessons Learned

### 1. Type Safety Requires Vigilance
Epic 9 established clear patterns for type safety, but Epic 10 still introduced violations. This suggests:
- The Epic 9 retro patterns may not have been widely communicated
- Code review should specifically check for `as any` and `as unknown` patterns
- Consider ESLint rules to ban these patterns

### 2. Enum Extension is Ongoing
New audit actions were added without extending the AuditAction enum. This pattern suggests:
- A review process should check enum usage when adding new features
- Consider making enums more flexible or extensible

### 3. Raw SQL Should Be Exception, Not Default
The holidays module uses raw SQL when Prisma would suffice. Guidelines needed:
- Use Prisma ORM by default
- Only use raw SQL for complex queries Prisma cannot handle
- Raw SQL must use parameterized queries

### 4. Hardcoded Paths Are Technical Debt
Configuration should be externalized, not hardcoded.

---

## Retro Quality Gate

| Criterion | Status |
|-----------|--------|
| All Epic 9 violations addressed | ❌ Failed |
| Security vulnerabilities fixed | ❌ Failed |
| Code follows established patterns | ⚠️ Partial |
| Documentation complete | ✅ Passed |
| Tests written for critical paths | ⚠️ Not Assessed |

---

## Next Steps

1. **Immediate**: Fix the SQL injection pattern and add missing AuditAction enum values
2. **Short-term**: Address all Epic 9 retro violations before Epic 11 starts
3. **Long-term**: Consider adding ESLint rules to prevent `as any` and `as unknown` casts

---

**Reviewed by**: Claude (AI Code Reviewer)
**Review Date**: 2026-01-07
**Review Type**: Adversarial Code Review (finding 3-10 issues per module)
