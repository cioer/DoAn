# Epic 2 Retrospective: Proposal Draft + Attachments + Form Registry

**Date:** 2026-01-06
**Epic:** Epic 2 - Proposal Draft + Attachments + Form Registry
**Status:** COMPLETE (6/6 stories done)
**Participants:** Coc (Project Lead), Bob (Scrum Master), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)

---

## Executive Summary

Epic 2 delivered the Form Registry with canonical section IDs, Proposal CRUD (Create, Read, Update, Delete), Auto-save with optimistic locking, Attachment Upload/Replace/Delete functionality, and Proposal Master Record structure with soft delete support. All 6 stories were completed with adversarial code reviews identifying and fixing issues across database schema, API endpoints, and frontend components.

**Key Achievement:** Established the foundational proposal data model with `form_data` JSON structure using canonical section IDs, enabling backward-compatible template versioning and robust CRUD operations.

**Process Note:** Test infrastructure was resolved during Epic 2 (bypassing NestJS DI in tests), enabling 115 tests to pass by story completion.

---

## Epic 2 Delivery Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 6/6 (100%) |
| Total Files Created/Modified | ~85 files |
| Code Review Issues Found | ~30 issues across 3 stories reviewed |
| Issues Fixed | All HIGH and MEDIUM issues addressed |
| Test Files Created | 12 (all tests passing) |
| Test Pass Rate | 115/115 tests passing (100%) |

---

## Stories Delivered

| Story | Title | Status | Key Output |
|-------|-------|--------|------------|
| 2-1 | Form Registry (Canonical Section IDs) | done | FormTemplate model, SectionId enum, 18 templates seeded |
| 2-2 | Create Proposal (DRAFT) | done | Proposal CRUD, form_data JSON structure, DT-XXX code generation |
| 2-3 | Auto-Save DRAFT | done | PATCH /auto-save endpoint, deep merge, optimistic locking |
| 2-4 | Upload Attachments (5MB/file cap) | done | Attachments module, file storage, validation |
| 2-5 | Attachment CRUD (Replace, Delete) | done | Replace/Delete endpoints, soft delete pattern |
| 2-6 | Proposal Master Record Structure | done | Form data helpers, advanced filtering, soft delete for proposals |

---

## What Went Well

**Alice (Product Owner):**
"The Form Registry with canonical section IDs is exactly what we needed. The backward compatibility design means we can add new sections without breaking existing proposals. The auto-save feature works seamlessly - users won't lose data anymore."

**Charlie (Senior Dev):**
"The test infrastructure fix was critical. By bypassing NestJS DI and manually creating service instances with mocks, we achieved 115 passing tests. The deep merge strategy for auto-save prevents data loss when concurrent edits happen."

**Dana (QA Engineer):**
"The soft delete pattern applied to both attachments and proposals is a game-changer. We can now recover accidentally deleted content. The 5MB per file and 50MB total validation prevents storage abuse effectively."

**Coc (Project Lead):**
"Epic 2 hoàn thành master record structure với form_data JSON theo canonical section IDs. Việc sử dụng Prisma-generated types đã giảm thiểu sự dư thừa code. Deep merge strategy trong auto-save đã giải quyết vấn đề data loss khi concurrent edits. Test infrastructure fix cho phép chạy 115 tests passing - một cải tiến lớn so với Epic 1."

**Elena (Junior Dev):**
"The useAutoSave hook with 2-second debounce is elegant. The queue-based approach cancels pending saves when new changes come in, preventing unnecessary API calls. The SaveIndicator component gives clear feedback to users."

---

## Challenges and Struggles

### Test Infrastructure Issues (Story 2.2)

**Issue:** NestJS Dependency Injection mocking was problematic in Vitest tests. Tests would fail with "Cannot read property of undefined" when trying to mock services.

**Resolution:** Implemented manual service instantiation with mock dependencies:
```typescript
const mockPrisma = { proposal: { findUnique: jest.fn() } };
const mockAuditService = { logEvent: jest.fn() };
const service = new ProposalsService(mockPrisma as any, mockAuditService as any);
```

**Impact:** This pattern was consistently applied across all Epic 2 stories, enabling 115 passing tests.

### Code Review Patterns Identified

| Pattern | Frequency | Stories Affected | Resolution |
|---------|-----------|------------------|------------|
| Missing audit event logging | 3 stories | 2-2, 2-5, 2-6 | Added PROPOSAL_DELETE, ATTACHMENT_REPLACE, PROPOSAL_RESTORE |
| Race condition in code generation | 1 story | 2-2 | Replaced count() with atomic $queryRaw(MAX()) |
| Lost `this` context in map() | 1 story | 2-2 | Changed to arrow function map(p => this.method(p)) |
| Route conflict (`/filter` before `/:id`) | 1 story | 2-6 | Reordered routes in controller |
| Missing soft delete handling | 2 stories | 2-5, 2-6 | Added deletedAt filtering consistently |

---

## Technical Debt Incurred

| Item | Priority | Impact | Status |
|------|----------|--------|--------|
| Manual DI bypass in tests | LOW | Works but not ideal | Acceptable for now |
| Local file storage only | MEDIUM | Won't scale horizontally | Deferred to Epic 7 (S3 TODO) |
| In-memory form validation | LOW | Doesn't cache | Acceptable for MVP |
| Missing frontend components | MEDIUM | Backend-only implementation | Deferred (no web app yet) |

**Design Decision:** Frontend components (FileUpload, SaveIndicator, AttachmentList) were created as reference implementations but not fully integrated, as this is a backend-focused monorepo.

---

## Architecture Highlights

### Form Data Structure (Canonical Section IDs)

The `form_data` JSON column in the `proposals` table stores data using stable section IDs:

```typescript
{
  "SEC_INFO_GENERAL": {
    "project_name": "Nghiên cứu AI",
    "research_field": "Công nghệ thông tin"
  },
  "SEC_BUDGET": {
    "total_budget": 50000000,
    "budget_breakdown": [...]
  },
  "SEC_ATTACHMENTS": [...]
  // ... other sections
}
```

This design enables:
- Backward compatibility: New sections can be added without breaking existing data
- Template versioning: Each proposal tracks its `template_id` and `template_version`
- Partial updates: Auto-save merges partial form data without overwriting

### Soft Delete Pattern

Applied consistently across attachments and proposals:
- `deletedAt DateTime?` column in database
- Soft delete: Set `deletedAt = now()`
- Query filter: `WHERE deletedAt IS NULL`
- Restore operation: Clear `deletedAt` timestamp

---

## Epic 3 Readiness Assessment

### Answer: READY

Epic 3 (Workflow Core + Queue + SLA) can begin with the following notes:

1. **Proposal Model Ready:** The `proposals` table includes all required fields for workflow:
   - `holder_unit` (String?) - Unit holding the proposal
   - `holder_user` (String?) - Specific user holding the proposal
   - `state` (ProjectState) - Current workflow state
   - `sla_deadline` (DateTime?) - SLA deadline for current state

2. **Audit Logging Foundation:** `AuditAction` enum includes:
   - PROPOSAL_CREATE, PROPOSAL_UPDATE, PROPOSAL_DELETE
   - PROPOSAL_AUTO_SAVE, PROPOSAL_SUBMIT
   - ATTACHMENT_UPLOAD, ATTACHMENT_REPLACE, ATTACHMENT_DELETE
   - PROPOSAL_RESTORE (Story 2.6)

3. **Test Infrastructure Working:** 115 passing tests demonstrate the test bypass pattern works consistently.

---

## Key Files Delivered

### Backend (NestJS)

| File | Purpose |
|------|---------|
| `prisma/schema.prisma` | FormTemplate, FormSection, Attachment models; Proposal with deletedAt |
| `apps/src/modules/form-templates/` | Form registry module (controller, service, DTOs) |
| `apps/src/modules/proposals/` | Proposal CRUD, auto-save, master record operations |
| `apps/src/modules/attachments/` | Attachment upload, replace, delete |
| `apps/src/common/constants/section-ids.ts` | Canonical section ID constants |
| `apps/src/seeds/form-templates.seed.ts` | 18 form templates (MAU_01B to MAU_18B) |

### Frontend (React Reference)

| File | Purpose |
|------|---------|
| `web-apps/src/hooks/useAutoSave.ts` | Auto-save with debounce, retry |
| `web-apps/src/components/forms/SaveIndicator.tsx` | Save status indicator |
| `web-apps/src/lib/api/proposals.ts` | Proposals API client |
| `web-apps/src/lib/api/attachments.ts` | Attachments API client |

### Helpers (Story 2.6)

| File | Purpose |
|------|---------|
| `apps/src/modules/proposals/dto/proposal-form-data.dto.ts` | TypeScript types for all form_data sections |
| `apps/src/modules/proposals/helpers/form-data.helper.ts` | getSectionData, setSectionData, mergeSectionData |

---

## Lessons Learned

### Positive Patterns to Continue

1. **Prisma-generated types** - Don't redefine types that Prisma generates
2. **Deep merge for JSON updates** - Preserves data not in current save
3. **Atomic operations for code generation** - Prevents race conditions
4. **Soft delete pattern** - Enables recovery without data loss
5. **Manual DI bypass in tests** - Works reliably for unit tests

### Process Improvements for Epic 3

1. **Route ordering** - Place parameterized routes (`/:id`) after specific routes (`/filter`)
2. **Audit logging** - Add audit events immediately when implementing actions
3. **Soft delete consistency** - Always add `deletedAt` filtering to queries
4. **Form data helpers** - Use getSectionData/setSectionData for all form_data access

---

## API Endpoints Delivered

### Proposals

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/proposals` | Create DRAFT proposal |
| GET | `/api/proposals` | List with filters |
| GET | `/api/proposals/:id` | Get by ID |
| PUT | `/api/proposals/:id` | Update DRAFT proposal |
| DELETE | `/api/proposals/:id` | Delete DRAFT proposal |
| PATCH | `/api/proposals/:id/auto-save` | Auto-save with deep merge |
| GET | `/api/proposals/:id/sections` | Get with filtered sections |
| GET | `/api/proposals/filter` | Advanced filtering |
| GET | `/api/proposals/holder/my-queue` | Get by holder |
| PATCH | `/api/proposals/:id/restore` | Restore soft-deleted |
| DELETE | `/api/proposals/:id/hard` | Soft delete |

### Attachments

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/proposals/:id/attachments` | Upload file |
| GET | `/api/proposals/:id/attachments` | List attachments |
| PUT | `/api/proposals/:id/attachments/:attachmentId` | Replace file |
| DELETE | `/api/proposals/:id/attachments/:attachmentId` | Delete file |

### Form Templates

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/form-templates` | List all templates |
| GET | `/api/form-templates/:id` | Get single template |
| GET | `/api/form-templates/:id/sections` | Get sections only |

---

## Code Review Summary

### Story 2-1 (Form Registry)

**Issues Found:** 9 (2 Critical, 4 High, 3 Medium, 0 Low)
**Key Fixes:**
- Added @UseGuards(AuthGuard, RolesGuard) to controller
- Added Proposal-FormTemplate relation in Prisma schema
- Fixed `any` type casting to use SectionId enum

### Story 2-2 (Create Proposal)

**Issues Found:** 8 (3 High, 2 Medium, 3 Low)
**Key Fixes:**
- Added PROPOSAL_DELETE audit event logging
- Fixed race condition in code generation with atomic $queryRaw()
- Fixed lost `this` context in array map()

### Story 2-6 (Master Record)

**Issues Found:** 5 (4 High, 1 Medium)
**Key Fixes:**
- Fixed mapToDtoWithTemplate to include deletedAt field
- Added audit logging to restore() function
- Fixed route conflict (moved /filter before /:id)

---

## Significant Discoveries

### 1. Route Ordering in NestJS

**Discovery:** Routes are matched in the order they're defined in the controller. A route like `@Get('filter')` must come before `@Get(':id')`, otherwise `filter` is treated as an ID.

**Impact:** Story 2.6 had to reorder routes in proposals.controller.ts.

### 2. Deep Merge Complexity

**Discovery:** Merging JSON form data requires careful handling of arrays vs objects. Arrays should be replaced (not merged), while objects should be recursively merged.

**Implementation:** The `deepMerge()` helper in proposals.service.ts handles this correctly.

### 3. Soft Delete Filtering

**Discovery:** Soft delete requires consistent filtering across ALL queries. Missing `deletedAt IS NULL` in even one query can cause unexpected behavior.

**Implementation:** Added helper methods `findAllWithFilters()` with `includeDeleted` option for consistency.

---

## Next Steps

1. **Begin Epic 3 (Workflow Core)**
   - Implement state transitions (DRAFT → FACULTY_REVIEW → ...)
   - Add holder rules (holder_unit, holder_user assignments)
   - Implement SLA calculations

2. **Frontend Integration** (when web app is prioritized)
   - Integrate FileUpload, SaveIndicator, AttachmentList components
   - Build proposal form page with DynamicFormRenderer
   - Add proposal list page with filters

3. **Monitoring**
   - Track file storage usage (currently local filesystem)
   - Monitor soft-deleted records for cleanup policy

---

## Retrospective Status

**Epic 1:** COMPLETE - Archived
**Epic 2:** COMPLETE - Ready for archival
**Epic 3:** READY - Can begin immediately

---

*Generated: 2026-01-06*
*Workflow: BMad Retrospective v1.0*
