# Epic 3 Retrospective: Workflow Core + Queue + SLA

**Date:** 2026-01-07
**Epic:** Epic 3 - Workflow Core + Queue + SLA
**Stories Completed:** 8/9 backend stories (3-7 is frontend-only)
**Status:** Backend Complete, Frontend Deferred

---

## Executive Summary

Epic 3 successfully implemented the core workflow engine, queue management, and SLA calculation system. All 8 backend stories are complete with 425+ tests passing. Story 3-7 (SLA Badge Component) is deferred until frontend development begins.

**Key Achievements:**
- 16 canonical state machine with holder-based routing
- Queue filters for "Äang chá» tÃ´i", "Cá»§a tÃ´i", "QuÃ¡ háº¡n", "Sáº¯p Ä‘áº¿n háº¡n"
- SLA calculator with business days + 17:00 cutoff logic
- Workflow logs timeline for audit trail
- Idempotency middleware for double-submit prevention
- PDF export service with Playwright

**Overall Grade:** A- (8/9 stories complete, excellent test coverage, frontend task appropriately deferred)

---

## Stories Summary

| Story | Title | Status | Tests | Key Changes |
|-------|-------|--------|-------|-------------|
| 3.1 | 16 Canonical States + Transitions | âœ… Done | 47 | Core state machine, WorkflowService, transition validation |
| 3.2 | Holder Rules (Unit + User) | âœ… Done | 78 | getHolderForState(), queue filter helpers |
| 3.3 | Submit Proposal (DRAFTâ†’FACULTY_REVIEW) | âœ… Done | 86+ | SLA integration, idempotency cache support |
| 3.4 | Workflow Logs (Timeline Thread View) | âœ… Done | 7 new | GET /workflow-logs endpoint with proposal validation |
| 3.5 | Queue Filters | âœ… Done | 31 new | Pagination validation, 5 filter types |
| 3.6 | SLA Calculator (Business Days + Cutoff) | âœ… Done | 20+ | Cutoff 17:00 logic, nextBusinessDay() |
| 3.7 | SLA Badge Component | â¸ï¸ Deferred | - | Frontend-only - deferred to frontend phase |
| 3.8 | Idempotency Keys | âœ… Done | 51 new | In-memory cache with lock-based race condition protection |
| 3.9 | PDF Export (WYSIWYG, SLA 10s) | âœ… Done | 26 | Playwright PDF generation, pre-generated seed support |

**Total Test Coverage:** 425+ tests passing (up from ~200 in Epic 2)

---

## What Went Well

### 1. Manual DI Pattern Continued from Epic 2
The manual dependency injection pattern established in Epic 2 proved robust:
```typescript
prismaMock = { proposal: { findUnique: jest.fn().mockResolvedValue(mockProposal) } };
service = new PdfService(prismaMock);
```
- Avoided vitest module mocking complexity
- Clear test setup, easy to debug
- Works consistently across all stories

### 2. Helper Functions Reused Across Stories
Story 3.2 created helper functions that were reused:
- `getMyQueueProposalsFilter()` - Used in Story 3.5 queue endpoint
- `getMyProposalsFilter()` - Used in Story 3.5
- `getOverdueProposalsFilter()` - Used in Story 3.5
- `isTerminalQueueState()` - Used for validation
- `getHolderForState()` - Core of all transitions

### 3. Idempotency Design with Lock Mechanism
Story 3.8 implemented robust double-submit prevention:
```typescript
acquireLock(key: string) { /* prevents race conditions */ }
waitForCachedResult(key: string) { /* second request waits for first */ }
```
- Handles concurrent double-click scenarios
- TTL configurable via environment variable
- Redis migration path documented

### 4. SLA Calculation with Cutoff Logic
Story 3.6 correctly handled the 17:00 cutoff:
```typescript
if (startDate.getHours() >= cutoffHour) {
  countFromDate = await this.nextBusinessDay(startDate);
}
```
- Friday 16:59 submit = Tuesday 17:00 deadline
- Friday 17:01 submit = Wednesday 17:00 deadline
- Holidays and weekends properly excluded

### 5. Code Review Feedback Quality
All stories went through code review and fixed issues:
- Story 3.1: Fixed magic strings, added validation
- Story 3.2: Fixed magic string "QUAN_LY_KHOA" â†’ `UserRole.QUAN_LY_KHOA`
- Story 3.4: Added proposal existence validation (404)
- Story 3.5: Added pagination parameter validation (NaN, negative, max 100)
- Story 3.8: Fixed race conditions, added lock mechanism

---

## What Could Be Improved

### 1. Story 3.7 (SLA Badge Component) - Frontend Task in Backend Epic
**Issue:** Story 3.7 is purely frontend (UI component) but was included in Epic 3.
**Impact:** Caused confusion during sprint planning.
**Lesson Learned:** Frontend-only stories should be in a separate frontend epic or clearly marked.
**Action Taken:** Deferred Story 3-7 until frontend development phase.

### 2. Vitest Module Mocking Complexity
**Issue:** Attempting to mock `fs/promises` and `playwright` in vitest proved difficult.
**Workaround:** Simplified PDF tests to focus on helper methods rather than end-to-end PDF generation.
**Future Consideration:** For integration testing PDF generation, use separate E2E test suite with actual Playwright.

### 3. Idempotency In-Memory vs Redis
**Issue:** Architecture specified Redis 7.x, but Story 3.8 implemented in-memory Map.
**Rationale:** Redis requires infrastructure setup; in-memory with locks provides protection for single-instance deployment.
**Migration Path:** Documented in story file for future Redis implementation using SETNX.

### 4. PDF Pre-generation Not Implemented
**Issue:** Story 3.9 AC6 specifies pre-generated PDFs for seed data, but actual PDF pre-generation script was not created.
**Status:** Service checks `public/pdfs/seed/` but no script exists to populate it.
**Action Item:** Add to Epic 6 (Acceptance & Handover) or separate "seed data enhancement" task.

### 5. Git vs Story File List Discrepancy
**Issue:** Some code reviews noted differences between git changes and story File List.
**Fix:** Updated File List in story file to match actual git commits.
**Pattern:** Always update File List during code review phase.

---

## Patterns Established

### 1. State Transition Pattern
```typescript
async transitionState(proposalId: string, toState: ProjectState, actorId: string) {
  return await this.prisma.$transaction(async (tx) => {
    // 1. Validate permission
    // 2. Get holder for new state
    // 3. Update proposal
    // 4. Create workflow log
    // 5. Create audit log
    // 6. Invalidate cache
  });
}
```
Used in all state-changing actions (Submit, Approve, Return, Resubmit).

### 2. Queue Filter Helper Pattern
```typescript
getMyQueueProposalsFilter(userId: string, userFacultyId: string, userRole: UserRole): Prisma.ProposalWhereInput
```
- Returns Prisma.WhereInput for type-safe queries
- Reusable across controller endpoints
- Testable in isolation

### 3. Idempotency Cache Pattern
```typescript
const cached = await cache.get(idempotencyKey);
if (cached) return cached;

const lock = await cache.acquireLock(idempotencyKey);
try {
  const result = await action();
  await cache.set(idempotencyKey, result, ttl);
  return result;
} finally {
  await cache.releaseLock(lock);
}
```
Applied to all state-changing POST/PUT/PATCH/DELETE endpoints.

### 4. Pagination Validation Pattern
```typescript
const page = Math.max(1, parseInt(pageQuery) || 1);
const pageSize = Math.min(100, Math.max(1, parseInt(pageSizeQuery) || 20));
if (isNaN(page) || isNaN(pageSize)) {
  throw new BadRequestException('Invalid pagination parameters');
}
```
Used in Story 3.5 queue endpoint.

### 5. Proposal Existence Check Pattern
```typescript
const proposal = await this.prisma.proposal.findUnique({ where: { id } });
if (!proposal) {
  throw new NotFoundException(`Proposal with ID ${id} not found`);
}
```
Added to Story 3.4 workflow logs endpoint per code review.

---

## Code Review Highlights

### Story 3.1 (States + Transitions)
- **Issues Fixed:** Magic string cleanup, validation added
- **Tests:** 47 tests passing for all 16 states

### Story 3.2 (Holder Rules)
- **Issues Fixed:** Magic string `UserRole.QUAN_LY_KHOA` used correctly
- **Tests:** 78 tests passing for holder logic

### Story 3.4 (Workflow Logs)
- **Issues Fixed:** Added proposal existence validation (404 NotFoundException)
- **Tests:** 7 controller tests added

### Story 3.5 (Queue Filters)
- **Issues Fixed:** Pagination parameter validation (NaN, negative, max cap at 100)
- **Tests:** 31 controller tests passing

### Story 3.8 (Idempotency)
- **HIGH Issues Fixed:** Race condition with lock-based protection, in-memory Map with locks
- **MEDIUM Issues Fixed:** Decorator return type, TTL configuration
- **Tests:** 51 tests (23 interceptor + 28 cache service)

---

## New Information Emerged

### 1. Idempotency Requires Lock Mechanism
During Story 3.8 implementation, discovered that simple in-memory cache is insufficient for concurrent double-click scenarios. Added:
- `acquireLock()` / `releaseLock()` methods
- `waitForCachedResult()` with retry logic
- Lock cleanup in `onModuleDestroy()`

### 2. SLA Cutoff Logic More Complex Than Expected
Story 3.6 revealed edge cases:
- Submit exactly at 17:00:00 should count as day 1
- Submit at 17:00:01 starts from next business day
- Requires `nextBusinessDay()` helper for cutoff handling

### 3. PDF Generation SLA (10s) Needs Progress Indicator
Story 3.9 specified 10s SLA for PDF generation but frontend progress indicator (AC3) is a frontend task. Backend provides PDF buffer but progress tracking requires frontend implementation.

### 4. workflow_logs Schema Already Complete
Story 3.4 discovered that workflow_logs table was already complete in Prisma schema (from Epic 1/2). Main task was adding GET endpoint for frontend consumption.

---

## Technical Debt Tracking

| Item | Story | Impact | Planned Fix |
|------|-------|--------|-------------|
| Redis for Idempotency | 3.8 | Medium | Migrate in-memory cache to Redis when scaling |
| PDF Pre-generation Script | 3.9 | Low | Add seed data enhancement task |
| workflow_logs idempotency_key field | 3.8 | Low | Requires Prisma schema migration |
| Vitest module mocking | 3.9 | Low | Use E2E tests for Playwright integration |

---

## Action Items for Epic 4

### 1. Leverage Existing State Machine
Epic 4 (Faculty Review + Changes Requested) should use:
- `WorkflowService.transitionState()` from Story 3.1
- `getHolderForState()` from Story 3.2
- `getMyQueueProposalsFilter()` from Story 3.2

### 2. Return Target Logic
Story 4.3 (Execute Return) must populate:
- `return_target_state` - EXPLICIT target state for resubmit
- `return_target_holder_unit` - EXPLICIT holder for resubmit
- `reason_code` - Selected reason from dropdown
- `revision_sections` - Array of selected section IDs

### 3. Resubmit Reads from workflow_logs
Story 4.5 (Resubmit Action) must:
- Read latest CHANGES_REQUESTED log entry
- Use `return_target_state` for transition (NOT inferred)
- Use `return_target_holder_unit` for holder assignment
- Reset SLA on resubmit (`sla_start_date = now()`)

### 4. Apply Idempotency to New Actions
All Epic 4 state-changing actions need:
- `@UseInterceptors(IdempotencyInterceptor)` decorator
- Frontend UUID v4 idempotency key generation (deferred)

### 5. Frontend Story Separation
Consider moving purely frontend stories (like 3.7) to a separate Frontend Epic to avoid confusion in backend planning.

---

## Metrics

| Metric | Epic 2 | Epic 3 | Change |
|--------|--------|--------|--------|
| Stories Completed | 6 | 8 | +2 |
| Test Coverage | ~200 | 425+ | +112% |
| Code Review Issues Found | 8 | 12 | +4 |
| Code Review Issues Fixed | 8 | 10 | +2 |
| Files Created | 15+ | 20+ | +5 |
| Modules Added | 2 | 3 | +1 |

---

## Handoff to Epic 4

### Ready to Use
1. **WorkflowService** - Complete state machine with transition validation
2. **Holder Rules Helper** - `getHolderForState()` for all 16 states
3. **Queue Filter Helpers** - Reusable Prisma.WhereInput generators
4. **Idempotency Interceptor** - Apply to new state-changing actions
5. **SLA Calculator** - `calculateDeadlineWithCutoff()` for SLA reset

### Epic 4 Story Dependencies
- Story 4.1 (Faculty Approve) â†’ Uses WorkflowService from 3.1
- Story 4.3 (Execute Return) â†’ Populates return_target fields
- Story 4.5 (Resubmit) â†’ Reads return_target from workflow_logs
- Story 4.6 (Revision PDF) â†’ May reuse PdfService from 3.9

### Risks to Watch
1. **Return Target Logic** - Must be EXPLICIT in workflow_logs, not inferred
2. **SLA Reset on Resubmit** - `sla_start_date = now()`, recalculate deadline
3. **Form Data Preservation** - CHANGES_REQUESTED state preserves form data (no versioning)
4. **Frontend-Backend Coordination** - Revision panel requires UI work

---

## Conclusion

Epic 3 successfully established the core workflow engine with comprehensive state management, queue filtering, SLA calculation, and idempotency protection. The patterns established (manual DI, helper functions, lock-based idempotency) will serve as a strong foundation for Epic 4's faculty review and changes requested functionality.

**Epic 3 Status:** âœ… Backend Complete
**Epic 4 Readiness:** ðŸŸ¢ Ready to Start

---

## Retrospective Participants
- **Product Owner:** Epic requirements from PRD/Epics
- **Architect:** Architecture decision document
- **Developer:** Implementation across 8 stories
- **Reviewer:** Code review feedback and fixes

**Next Retrospective:** After Epic 4 (Faculty Review + Changes Requested + Resubmit)
