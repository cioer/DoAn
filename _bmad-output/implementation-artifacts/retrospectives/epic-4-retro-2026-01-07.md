# Epic 4 Retrospective: Faculty Review + Changes Requested + Resubmit

**Date:** 2026-01-07
**Epic:** Epic 4 - Faculty Review + Changes Requested + Resubmit
**Stories Completed:** 6/6 stories
**Status:** ‚úÖ Complete

---

## Executive Summary

Epic 4 successfully implemented faculty review workflow with comprehensive changes requested and resubmit functionality. All 6 stories are complete with code review fixes applied.

**Key Achievements:**
- Faculty approve action with state transition to SCHOOL_SELECTION_REVIEW
- Faculty return dialog with reason codes and section-level revision targeting
- Return target storage (return_target_state, return_target_holder_unit) for correct resubmit behavior
- Changes requested banner for visibility
- Revision panel with checkbox "ƒê√£ s·ª≠a" MVP and localStorage persistence
- Resubmit action reading return target from workflow log
- Revision PDF export with Vietnamese content

**Overall Grade:** A (6/6 stories complete, all code review issues fixed)

---

## Stories Summary

| Story | Title | Status | Tests | Key Changes |
|-------|-------|--------|-------|-------------|
| 4.1 | Faculty Approve Action | ‚úÖ Done | 37 | Approve endpoint, RBAC, state transition to SCHOOL_SELECTION_REVIEW |
| 4.2 | Faculty Return Dialog | ‚úÖ Done | 8 new | Return dialog, reason codes, section checkboxes, return target storage |
| 4.3 | Execute Return + Banner | ‚úÖ Done | 43 total | ChangesRequestedBanner, getLatestReturn API |
| 4.4 | Revision Panel | ‚úÖ Done | Created | Checkbox "ƒê√£ s·ª≠a", localStorage, click-to-scroll, 4 fixes |
| 4.5 | Resubmit Action | ‚úÖ Done | New | Reads return_target from log, SLA reset, 3 fixes |
| 4.6 | Revision PDF Export | ‚úÖ Done | New | PDF generation, download button, 3 fixes |

**Total Code Review Fixes:** 10 HIGH priority issues fixed

---

## What Went Well

### 1. Return Target Pattern Success
Story 4.2 correctly implemented EXPLICIT return target storage:
```typescript
returnTargetState: proposal.state, // FACULTY_REVIEW
returnTargetHolderUnit: proposal.facultyId, // Source of truth
```
This enabled Story 4.5 resubmit to correctly route back to the reviewing faculty without inference logic.

### 2. Reusable Patterns from Epic 3
Epic 4 successfully leveraged patterns established in Epic 3:
- `WorkflowService.transitionState()` for state changes
- `IdempotencyInterceptor` for double-submit prevention
- `getHolderForState()` for holder unit resolution
- X-Idempotency-Key header pattern

### 3. localStorage for Revision Panel
Story 4.4 implemented localStorage with proper cleanup:
- Namespaced keys: `qlnckh.revision.${proposalId}`
- Cleanup on unmount to prevent stale data
- Conditional "N·ªôp l·∫°i" button enablement

### 4. Promise Caching for Race Conditions
Story 4.5 implemented robust idempotency with promise caching:
```typescript
if (cached instanceof Promise) {
  return cached; // Wait for first request to complete
}
```
This prevents race conditions from concurrent double-clicks.

### 5. PDF Service Reuse
Story 4.6 reused PdfService from Story 3.9:
- Extended with `generateRevisionPdf()` method
- Added `getProposalCode()` public method (code review fix)
- Proper browser cleanup in finally block (code review fix)

### 6. Vietnamese Language Support
All user-facing text properly localized:
- Error messages in Vietnamese
- PDF content with Vietnamese labels
- RETURN_REASON_LABELS mapping

---

## What Could Be Improved

### 1. Frontend Tests Path Alias Issue
**Issue:** `@` path alias not resolving in vitest for `.tsx` files
**Impact:** Component tests cannot run without manual vitest config fix
**Status:** Pre-existing issue from earlier stories, noted but unresolved
**Action Item:** Fix vitest.config.ts to use jsdom environment for .tsx files

### 2. Code Review Found 10 HIGH Issues
**Issue:** Initial implementation had 10 HIGH priority issues across Stories 4-4, 4-5, 4-6
**Impact:** Required additional fix commit before stories could be marked done
**Root Cause:**
- Browser resource leaks (missing finally cleanup)
- Private property access violations
- Vietnamese error messages not consistent
- Race conditions in idempotency check
**Resolution:** All issues fixed and verified

### 3. E2E Tests Not Implemented
**Issue:** Story 4.2 has E2E tests (Task 10) marked as pending in code review
**Impact:** No end-to-end validation of return dialog flow
**Recommendation:** Add Playwright E2E tests for critical workflows

### 4. lucide-react Package Installation
**Issue:** Story 4.3 required manual `npm install lucide-react@latest`
**Impact:** Development interruption, should have been in package.json from start
**Lesson:** Check icon library dependencies during story creation

---

## Patterns Established

### 1. Return Target Pattern
```typescript
// When returning proposal, store EXPLICIT target
const returnTargetState = proposal.state; // Save current state
const returnTargetHolderUnit = proposal.facultyId; // Save current holder

// When resubmitting, read EXPLICIT target
const lastReturnLog = await workflowLog.findFirst({
  where: { proposalId, toState: 'CHANGES_REQUESTED' },
});
const targetState = lastReturnLog.returnTargetState; // NOT inferred
```

### 2. localStorage Cleanup Pattern
```typescript
useEffect(() => {
  const storageKey = `qlnckh.revision.${proposalId}`;
  return () => {
    localStorage.removeItem(storageKey); // Cleanup on unmount
  };
}, [proposalId]);
```

### 3. Promise Caching for Idempotency
```typescript
if (context.idempotencyKey) {
  const cached = this.idempotencyStore.get(context.idempotencyKey);
  if (cached instanceof Promise) {
    return cached; // Handle concurrent requests
  }
}
```

### 4. Vietnamese Error Response Pattern
```typescript
throw new BadRequestException({
  success: false,
  error: {
    code: 'INVALID_SECTIONS',
    message: 'C√°c section kh√¥ng h·ª£p l·ªá...', // Vietnamese message
  },
});
```

---

## Code Review Highlights

### Story 4.1 (Faculty Approve)
- **HIGH #1 FIXED:** X-Idempotency-Key header added to API calls
- **LOW #1 FIXED:** Demo page added for proposal actions
- Tests: 37 backend tests passing

### Story 4.4 (Revision Panel)
- **HIGH #1 FIXED:** localStorage cleanup on component unmount
- **HIGH #2 FIXED:** Accessibility fix - removed preventDefault on label
- **HIGH #3 FIXED:** Button disabled when sectionItems.length === 0
- **HIGH #4 FIXED:** localStorage key namespacing with `qlnckh.revision.` prefix

### Story 4.5 (Resubmit Action)
- **HIGH #1 FIXED:** Race condition with promise caching pattern
- **HIGH #2 FIXED:** getUserDisplayName moved outside transaction
- **HIGH #3 FIXED:** Validate checkedSections against revisionSections

### Story 4.6 (Revision PDF Export)
- **HIGH #1 FIXED:** Added getProposalCode() public method instead of accessing private prisma
- **HIGH #2 FIXED:** Browser cleanup in finally block to prevent resource leaks
- **HIGH #3 FIXED:** Vietnamese error messages for consistency

---

## New Information Emerged

### 1. Return Target Must Be EXPLICIT
Epic 4 confirmed that return target cannot be inferred from previous state. Must be stored EXPLICITLY in workflow log:
- `return_target_state`: Where to go after resubmit (FACULTY_REVIEW)
- `return_target_holder_unit`: Which faculty reviews next

### 2. Resubmit Does NOT Go to DRAFT
Traditional edit flow returns to DRAFT, but faculty review resubmit goes back to the reviewing faculty (FACULTY_REVIEW). This preserves the review context and form data.

### 3. SLA Reset on Resubmit
When proposal is resubmitted:
- `sla_start_date = now()` - Reset timer
- `sla_deadline = now() + 3 working days` - Fresh SLA for review

### 4. Checkbox "ƒê√£ s·ª≠a" Is User-Driven
Story 4.4 confirmed MVP approach: user manually checks "ƒê√£ s·ª≠a" checkboxes. No automatic hash detection of field changes.

---

## Technical Debt Tracking

| Item | Story | Impact | Planned Fix |
|------|-------|--------|-------------|
| Vitest path alias (@) | All frontend | Medium | Fix vitest.config.ts for .tsx files |
| E2E Tests for Return Flow | 4.2 | Low | Add Playwright E2E tests |
| Pre-generated PDF Seeds | 3.9 | Low | Add seed data enhancement task (deferred) |

---

## Action Items for Epic 5

### 1. Use Return Target Pattern for School Return
Epic 5 (School Ops + Council Review) may have school-level returns. Use the same return_target pattern:
```typescript
returnTargetState: 'SCHOOL_SELECTION_REVIEW',
returnTargetHolderUnit: 'PHONG_KHCN',
```

### 2. Apply localStorage Cleanup Pattern
Any components using localStorage should follow the cleanup pattern from Story 4.4:
- Namespace keys with app prefix
- Cleanup on unmount
- Handle localStorage errors gracefully

### 3. Continue Vietnamese Localization
Epic 5 should maintain Vietnamese error messages:
- All API error responses in Vietnamese
- User-facing labels in Vietnamese
- Consistent terminology

### 4. Use Promise Caching for Idempotency
Epic 5 state-changing actions should use the promise caching pattern from Story 4.5 for race condition prevention.

---

## Epic 3 Retro Follow-Through

### Action Items from Epic 3 Retro

| Action Item | Status | Evidence |
|-------------|--------|----------|
| Use WorkflowService.transitionState() | ‚úÖ Applied | All Epic 4 transitions use service |
| Populate return_target fields | ‚úÖ Applied | Story 4.2 stores EXPLICIT targets |
| Resubmit reads from workflow_logs | ‚úÖ Applied | Story 4.5 reads return_target |
| Apply IdempotencyInterceptor | ‚úÖ Applied | All POST endpoints use interceptor |

### Lessons Applied from Epic 3

1. **State Transition Pattern** ‚úÖ
   - Used `WorkflowService.approveFacultyReview()` from Epic 3
   - Consistent workflow log creation

2. **Idempotency with Locks** ‚úÖ
   - Story 4.5 extended with promise caching
   - Handles concurrent double-click scenarios

3. **Helper Functions** ‚úÖ
   - `getHolderForState()` used for holder resolution
   - Queue filter patterns available for Epic 5

4. **Pagination Validation** ‚úÖ
   - Epic 4 endpoints follow validation patterns from Story 3.5

---

## Next Epic Preview: Epic 5

### Epic 5: School Ops + Council Review

**Objective:** PKHCN ph√¢n b·ªï cho h·ªôi ƒë·ªìng tr∆∞·ªùng ‚Üí H·ªôi ƒë·ªìng ƒë√°nh gi√° ‚Üí Submit ONCE ‚Üí kh√≥a ch·ªânh s·ª≠a.

**Dependencies on Epic 4:**
1. **SCHOOL_SELECTION_REVIEW State** - Target of Epic 4's approve action
2. **Return Target Pattern** - May be needed for school-level returns
3. **Workflow Log Timeline** - Used by council review workflow

**Potential Risks:**
1. Council assignment logic not yet defined
2. Evaluation form structure unknown
3. "Submit ONCE" locking mechanism needs design

**Preparation Needed:**
- None identified - Epic 4 completion solid
- Epic 5 can proceed with story creation

---

## Readiness Assessment

**Testing & Quality:** ‚úÖ Good
- Backend tests passing (37+ workflow tests)
- Code review issues all fixed
- Frontend tests have config issue (pre-existing)

**Deployment:** ‚è∏Ô∏è Pending
- Not deployed yet (development environment)

**Stakeholder Acceptance:** ‚è∏Ô∏è Pending
- Pending user review

**Technical Health:** ‚úÖ Good
- Clean code after code review fixes
- No blocking technical debt
- Patterns established for reuse

**Unresolved Blockers:** None

---

## Key Takeaways

1. **Return Target Pattern Works** - EXPLICIT storage prevents complex inference logic
2. **Promise Caching Solves Race Conditions** - Handles concurrent double-clicks elegantly
3. **Code Review Quality High** - Found 10 issues that improved code quality
4. **Vietnamese Localization Complete** - Consistent language support across all stories
5. **Patterns Established** - Epic 4 patterns ready for Epic 5 reuse

---

## Commitments Made Today

**Action Items:** 3
1. Fix vitest.config.ts for @ path alias resolution (Frontend)
2. Add E2E tests for return dialog flow (QA)
3. Add lucide-react to package.json upfront (Dev)

**Preparation Tasks for Epic 5:** 0
- No critical preparation needed
- Epic 4 work is solid foundation

**Critical Path Items:** 0
- No blockers to Epic 5 start

---

## Team Performance

Epic 4 delivered 6 stories with 10 code review fixes all resolved. The retrospective surfaced key patterns (return target, promise caching, localStorage cleanup) that will serve Epic 5 well.

**Epic 4 Status:** ‚úÖ Complete
**Epic 5 Readiness:** üü¢ Ready to Start

---

## Retrospective Participants
- **Product Owner:** Epic requirements from PRD/Epics
- **Scrum Master:** Retrospective facilitation
- **Developer:** Implementation across 6 stories
- **Code Reviewer:** Found and fixed 10 HIGH priority issues

**Next Retrospective:** After Epic 5 (School Ops + Council Review)
