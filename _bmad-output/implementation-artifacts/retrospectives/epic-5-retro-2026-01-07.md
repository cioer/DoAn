# Epic 5 Retrospective: School Ops + Council Review

**Date:** 2026-01-07
**Epic:** Epic 5 - School Ops + Council Review
**Stories Completed:** 6/6 stories
**Status:** Complete

---

## Executive Summary

Epic 5 successfully implemented the school-level council assignment and evaluation workflow. All 6 stories are complete with code review fixes applied.

**Key Achievements:**
- School selection queue for PKHCN role
- Council assignment with secretary delegation
- Evaluation form draft with auto-save
- Preview PDF + confirm gate before finalization
- Submit ONCE with read-only lock
- Evaluation PDF export

**Overall Grade:** A (6/6 stories complete, all code review issues fixed)

---

## Stories Summary

| Story | Title | Status | Tests | Key Changes |
|-------|-------|--------|-------|-------------|
| 5.1 | School Selection Queue | Done | New | Queue filter for SCHOOL_SELECTION_REVIEW state |
| 5.2 | Council Assignment | Done | New | Council module, ASSIGN_COUNCIL workflow action |
| 5.3 | Evaluation Form Draft | Done | New | Evaluation model, auto-save integration |
| 5.4 | Preview PDF + Confirm Gate | Done | New | IdempotencyInterceptor, EVALUATION_SUBMITTED action |
| 5.5 | Finalize Read-Only | Done | New | 403 Forbidden on edit FINALIZED evaluations |
| 5.6 | Evaluation PDF Export | Done | New | RBAC check, instanceof fix for ForbiddenException |

**Total Code Review Fixes:** 7 (1 Critical, 2 High, 3 Medium, 1 Low) - All Fixed

---

## What Went Well

### 1. IdempotencyInterceptor Reuse
Story 5.4 successfully applied `IdempotencyInterceptor` from Story 3.8:
```typescript
@UseInterceptors(IdempotencyInterceptor) // Reused from Epic 3
@Controller('evaluations')
export class EvaluationController { ... }
```
This prevented duplicate evaluation submissions without custom Redis code.

### 2. Evaluation State Naming Consistency
Story 5.4 renamed `SUBMITTED` to `FINALIZED` for clarity:
```prisma
enum EvaluationState {
  DRAFT      // ng soạn thảo
  FINALIZED  // ã hoàn tất (sau khi finalize - Story 5.4)
}
```
This avoids confusion with project state transitions.

### 3. Proposal Transition Within Evaluation Submit
Story 5.4 correctly wrapped evaluation finalization AND proposal transition in a single Prisma transaction:
```typescript
return this.prisma.$transaction(async (tx) => {
  // 1. Finalize evaluation
  const evaluation = await tx.evaluation.update({...});

  // 2. Transition proposal to APPROVED
  const updatedProposal = await tx.proposal.update({
    where: { id: proposalId },
    data: {
      state: ProjectState.APPROVED,
      holderUnit: evaluation.proposal.facultyId, // Return to PI
      holderUser: evaluation.proposal.ownerId,
    },
  });

  // 3. Log workflow: EVALUATION_SUBMITTED
  await tx.workflowLog.create({...});
});
```

### 4. New WorkflowAction Enum Value
Story 5.4 added `EVALUATION_SUBMITTED` to `WorkflowAction` enum for proper audit trail:
```prisma
enum WorkflowAction {
  // ... existing actions
  EVALUATION_SUBMITTED // Nộp phiếu đánh giá (Story 5.4)
}
```

### 5. RBAC for PDF Export
Story 5.6 added proper role-based access control:
```typescript
@UseGuards(RolesGuard)
@RequireRoles(UserRole.THU_KY_HOI_DONG, UserRole.PHONG_KHCN, UserRole.ADMIN)
@Get(':id/evaluation-pdf')
async getEvaluationPdf(@Param('id') id: string, @Res() res: Response) { ... }
```

### 6. WYSIWYG PDF Pattern Consistency
Stories 5.4 and 5.6 followed the WYSIWYG pattern from Epic 3:
- HTML/CSS + Playwright for PDF generation
- Force light theme for print consistency
- Same CSS for preview modal and final PDF

---

## What Could Be Improved

### 1. Idempotency Key Initially Not Used by Controller FIXED
**Issue:** Story 5.4 initial implementation accepted `idempotencyKey` in DTO but didn't use it
**Impact:** Idempotency not actually working despite passing the key
**Root Cause:** `IdempotencyInterceptor` not applied to `EvaluationsController`
**Status:** FIXED 2026-01-07
**Solution:** Added `@UseInterceptors(IdempotencyInterceptor)` to controller

### 2. Code Review Found 7 Issues
**Issue:** Stories 5-4, 5-5, 5-6 had 7 issues across Critical, High, Medium, Low priorities
**Impact:** Required additional fix commit before stories could be marked done
**Root Cause:**
- Missing IdempotencyInterceptor on controller
- Missing RBAC guard on PDF export endpoint
- Using `error.name` instead of `instanceof` for exception checking
**Resolution:** All issues fixed and verified

---

## Patterns Established

### 1. Evaluation Finalization Pattern
```typescript
// Submit evaluation = Finalize evaluation + Transition proposal
async submitEvaluation(proposalId: string, evaluatorId: string) {
  return this.prisma.$transaction(async (tx) => {
    // 1. evaluation: DRAFT → FINALIZED
    // 2. proposal: OUTLINE_COUNCIL_REVIEW → APPROVED
    // 3. holder: returns to PI (owner)
    // 4. workflow log: EVALUATION_SUBMITTED
  });
}
```

### 2. Council Assignment Pattern
```typescript
// When assigning council, holder becomes council secretary
const council = await tx.council.findUnique({ where: { id: councilId } });
await tx.proposal.update({
  data: {
    state: 'OUTLINE_COUNCIL_REVIEW',
    holderUnit: councilId,      // Council as unit
    holderUser: council.secretaryId,  // Secretary as user
  },
});
```

### 3. Read-Only Mode After Finalization
```typescript
// Frontend: Check state for read-only mode
const isReadOnly = evaluation?.state === 'FINALIZED';

// Backend: Enforce at API level
if (evaluation.state !== 'DRAFT') {
  throw new ForbiddenException({
    success: false,
    error: {
      code: 'EVALUATION_FINALIZED',
      message: 'Đánh giá đã hoàn tất. Không thể chỉnh sửa.',
    },
  });
}
```

---

## Code Review Highlights

### Story 5.4 (Preview PDF + Confirm Gate)
- **CRITICAL #1 FIXED:** IdempotencyInterceptor added to EvaluationsController
- **HIGH #2 FIXED:** Idempotency header now properly processed by interceptor
- **MEDIUM #3 FIXED:** Added EVALUATION_SUBMITTED to WorkflowAction enum

### Story 5.5 (Finalize Read-Only)
- **LOW #1:** Owner faculty ID reference verified correct (holderUnit → facultyId)

### Story 5.6 (Evaluation PDF Export)
- **HIGH #1 FIXED:** Added RBAC check (@RequireRoles) to PDF export endpoint
- **MEDIUM #2 FIXED:** API endpoint documented matches implementation
- **MEDIUM #3 FIXED:** Use instanceof for ForbiddenException type check

---

## New Information Emerged

### 1. Evaluation Submission Also Transitions Proposal
Epic 5 revealed that submitting an evaluation also needs to transition the proposal to APPROVED and return holder to the PI. This is NOT just about evaluation state.

### 2. Two-Level State Management
Epic 5 introduced dual state management:
- **Proposal state:** OUTLINE_COUNCIL_REVIEW → APPROVED
- **Evaluation state:** DRAFT → FINALIZED

These must transition atomically in the same transaction.

### 3. Council as a Holder Unit
The council itself becomes the holder unit during evaluation:
- `holderUnit = councilId` (not a role code)
- `holderUser = secretaryId` (specific user)

This differs from other holder patterns where holderUnit is a role code (PHONG_KHCN, etc.).

### 4. Submit ONCE Lock is at Evaluation Level
The submit ONCE lock is implemented via:
- State check: `evaluation.state === 'FINALIZED'` → 403 on PATCH
- UI: All inputs disabled when FINALIZED
- No separate lock mechanism needed

---

## Technical Debt Tracking

| Item | Story | Impact | Planned Fix | Status |
|------|-------|--------|-------------|--------|
| None identified | - | - | - | - |

---

## Action Items for Epic 6

### 1. Use Atomic Transaction Pattern
Epic 6 (Acceptance & Handover) will have similar multi-entity transitions. Follow the pattern from Story 5.4:
```typescript
this.prisma.$transaction(async (tx) => {
  // Update multiple related entities atomically
  // Create workflow log entry
  // Return combined result
});
```

### 2. Continue RBAC for Downloadable Content
Epic 6 will have dossier pack downloads. Use the RBAC pattern from Story 5.6:
```typescript
@UseGuards(RolesGuard)
@RequireRoles(UserRole.PHONG_KHCN, UserRole.ADMIN)
```

### 3. Apply Read-Only Pattern After Finalization
Any finalization actions in Epic 6 should follow the read-only pattern:
- State check in PATCH endpoint → 403 if finalized
- UI disabled state based on state
- Badge display for finalized status

---

## Epic 4 Retro Follow-Through

### Action Items from Epic 4 Retro

| Action Item | Status | Evidence |
|-------------|--------|----------|
| Use Return Target Pattern | N/A | No school-level returns in Epic 5 |
| Apply localStorage Cleanup | Applied | EvaluationForm uses cleanup on unmount |
| Continue Vietnamese Localization | Applied | All UI text in Vietnamese |
| Use Promise Caching for Idempotency | Applied | IdempotencyInterceptor handles caching |

### Lessons Applied from Epic 4

1. **State Transition Pattern**
   - Used `WorkflowService.transitionState()` approach
   - Consistent workflow log creation

2. **Idempotency with Interceptor**
   - Applied `IdempotencyInterceptor` to EvaluationsController
   - Handles race conditions automatically

3. **Vietnamese Error Messages**
   - All API errors use Vietnamese text
   - Consistent terminology across stories

---

## Next Epic Preview: Epic 6

### Epic 6: Acceptance & Handover + Dossier Pack

**Objective:** Project start → Faculty acceptance → School acceptance → Handover with dossier pack → ZIP export.

**Dependencies on Epic 5:**
1. **APPROVED State** - Starting point for Epic 6
2. **Holder Rules** - Returns to PI after evaluation
3. **Evaluation Record** - Referenced in dossier pack

**Potential Risks:**
1. Multi-level acceptance flow (faculty then school)
2. Dossier pack checklist structure undefined
3. ZIP export may need archiving library

**Preparation Needed:**
- Define dossier pack checklist items
- Plan ZIP generation approach
- Design acceptance vote UI

---

## Readiness Assessment

**Testing & Quality:** Good
- All code review issues fixed
- TypeScript compilation passing
- Tests created for new components

**Deployment:** Pending
- Development environment only

**Stakeholder Acceptance:** Pending
- Pending user review

**Technical Health:** Good
- Clean code after code review fixes
- No blocking technical debt
- Patterns established for reuse

**Unresolved Blockers:** None

---

## Key Takeaways

1. **IdempotencyInterceptor is Powerful** - Reusable across all state-changing endpoints
2. **Multi-Entity Transactions Work** - Atomic transitions maintain consistency
3. **Council as Holder Unit is Unique** - Different pattern from role-based holders
4. **EVALUATION_SUBMITTED Action Needed** - Separate workflow action for audit trail
5. **RBAC Critical for Downloads** - PDF export needs role checking

---

## Commitments Made Today

**Action Items:** 0
- All code review issues fixed
- No outstanding action items

**Preparation Tasks for Epic 6:** 0
- Epic 5 completion solid
- Epic 6 ready to start

**Critical Path Items:** 0
- No blockers to Epic 6 start

---

## Team Performance

Epic 5 delivered 6 stories with 7 code review fixes all resolved. The retrospective established patterns (evaluation finalization, council assignment, read-only mode) that will serve Epic 6 well.

**Epic 5 Status:** Complete
**Epic 6 Readiness:** Ready to Start

---

## Retrospective Participants
- **Product Owner:** Epic requirements from PRD/Epics
- **Scrum Master:** Retrospective facilitation
- **Developer:** Implementation across 6 stories
- **Code Reviewer:** Found and fixed 7 issues

**Next Retrospective:** After Epic 6 (Acceptance & Handover + Dossier Pack)
