# Epic 6 Retrospective: Acceptance & Handover + Dossier Pack

**Date:** 2026-01-07
**Epic:** Epic 6 - Acceptance & Handover + Dossier Pack
**Stories Completed:** 6/6 stories
**Status:** Complete

---

## Executive Summary

Epic 6 successfully implemented the project acceptance and handover workflow with dossier pack export functionality. All 6 stories are complete with code review fixes applied during this retrospective session.

**Key Achievements:**
- Start Project action (APPROVED → IN_PROGRESS with actualStartDate)
- Submit Faculty Acceptance Review (IN_PROGRESS → FACULTY_ACCEPTANCE_REVIEW)
- Faculty Acceptance Vote (DAT → SCHOOL, KHONG_DAT → IN_PROGRESS)
- School Acceptance Vote (DAT → HANDOVER, KHONG_DAT → IN_PROGRESS)
- Handover + Checklist (HANDOVER → COMPLETED with completedDate)
- ZIP Dossier Pack Export (SLA 30s with RBAC)

**Overall Grade:** A (6/6 stories complete, all code review issues fixed)

---

## Stories Summary

| Story | Title | Status | Tests | Key Changes |
|-------|-------|--------|-------|-------------|
| 6.1 | Start Project | Done | New | actualStartDate set, START_PROJECT action |
| 6.2 | Submit Faculty Acceptance Review | Done | New | formData with acceptance results/products |
| 6.3 | Faculty Acceptance Vote | Done | New | Dual state transitions, comments required for reject |
| 6.4 | School Acceptance Vote | Done | New | Both outcomes return to owner |
| 6.5 | Handover + Dossier Pack Checklist | Done | New | completedDate set, read-only after COMPLETED |
| 6.6 | ZIP Dossier Pack Export | Done | New | DossierExportService with RBAC |

**Total Code Review Fixes:** 5 (1 Critical, 1 High, 2 Medium, 1 Low) - All Fixed

---

## What Went Well

### 1. Atomic Transaction Pattern Applied Consistently
All Epic 6 service methods followed the Epic 5 pattern:
```typescript
return this.prisma.$transaction(async (tx) => {
  // 1. Update proposal state
  // 2. Update formData
  // 3. Create workflow log entry
  // Return updated proposal
});
```

### 2. Dual-Level Acceptance Flow
Stories 6.3 and 6.4 implemented a clean two-level acceptance:
- **Faculty Acceptance:** DAT → School level, KHONG_DAT → Back to PI
- **School Acceptance:** DAT → Handover, KHONG_DAT → Back to PI
- Different holder rules at each level

### 3. Handover Checklist with Auto-Save
Story 6.5 implemented auto-save for draft checklist (reusing Story 2.3 pattern):
```typescript
async saveHandoverChecklist(proposalId, userId, dto) {
  // Save draft to formData
  // Enable auto-save on frontend
}
```

### 4. Dossier Export RBAC
Story 6.6 added proper role-based access control for different pack types:
```typescript
canExportPack(packType: DossierPackType, userRole: UserRole): boolean {
  switch (packType) {
    case DossierPackType.FACULTY_ACCEPTANCE:
      return [UserRole.QUAN_LY_KHOA, UserRole.ADMIN].includes(userRole);
    case DossierPackType.SCHOOL_ACCEPTANCE:
      return [UserRole.PHONG_KHCN, UserRole.ADMIN].includes(userRole);
    // ...
  }
}
```

### 5. actualStartDate and completedDate Tracking
New fields added to Proposal model:
- `actualStartDate` - Set when starting project (Story 6.1)
- `completedDate` - Set when completing handover (Story 6.5)

### 6. WorkflowAction Enum Values
All Epic 6 actions properly added to WorkflowAction enum:
- START_PROJECT
- SUBMIT_FACULTY_ACCEPTANCE
- FACULTY_ACCEPT / FACULTY_REJECT
- SCHOOL_ACCEPT / SCHOOL_REJECT
- HANDOVER_COMPLETE

---

## What Could Be Improved

### 1. Unsafe Type Casting in Controllers FIXED
**Issue:** All Epic 6 endpoints used `dto as unknown as {...}` which bypassed DTO validation
**Impact:** class-validator decorators never executed
**Root Cause:** Type casting bypassed NestJS validation pipes
**Status:** FIXED 2026-01-07
**Solution:** Properly map DTOs to service contracts

**Before (WRONG):**
```typescript
dto as unknown as { results: string; products: Array<...> }
```

**After (CORRECT):**
```typescript
const serviceDto = {
  results: dto.results,
  products: dto.products.map(p => ({
    name: p.name,
    type: p.type,
    note: p.note,
    attachmentId: p.attachmentId,
  })),
  attachmentIds: dto.attachmentIds,
};
```

### 2. String Literals for WorkflowAction FIXED
**Issue:** Service methods used string literals instead of enum
**Impact:** No type safety, typos possible at runtime
**Status:** FIXED 2026-01-07
**Solution:** Import and use WorkflowAction enum

**Before:**
```typescript
action: 'START_PROJECT'
action: isAccept ? 'FACULTY_ACCEPT' : 'FACULTY_REJECT'
```

**After:**
```typescript
import { WorkflowAction } from '@prisma/client';
action: WorkflowAction.START_PROJECT
action: isAccept ? WorkflowAction.FACULTY_ACCEPT : WorkflowAction.FACULTY_REJECT
```

### 3. holderUnit for PHONG_KHCN Was Unclear FIXED
**Issue:** Using `null` for PHONG_KHCN holder was not self-documenting
**Impact:** Code harder to understand
**Status:** FIXED 2026-01-07
**Solution:** Added HOLDER_PHONG_KHCN constant with JSDoc

---

## Patterns Established

### 1. Multi-Level Acceptance Pattern
```typescript
// Faculty Acceptance (Story 6.3)
const isAccept = dto.decision === 'DAT';
const nextState = isAccept ? ProjectState.SCHOOL_ACCEPTANCE_REVIEW : ProjectState.IN_PROGRESS;
const holderUnit = isAccept ? ProposalsService.HOLDER_PHONG_KHCN : existing.facultyId;

// School Acceptance (Story 6.4)
const isAccept = dto.decision === 'DAT';
const nextState = isAccept ? ProjectState.HANDOVER : ProjectState.IN_PROGRESS;
const holderUnit = existing.facultyId; // Both return to owner
```

### 2. Comments Required for Rejection Pattern
```typescript
// Validate comments required when KHONG_DAT
if (dto.decision === 'KHONG_DAT' && !dto.comments) {
  throw new BadRequestException({
    error: {
      code: 'COMMENTS_REQUIRED',
      message: 'Vui lòng nhập lý do không đạt',
    },
  });
}
```

### 3. Read-Only State Enforcement After Finalization
```typescript
// Explicit check for COMPLETED state
if (existing.state === ProjectState.COMPLETED) {
  throw new BadRequestException({
    error: {
      code: 'READ_ONLY',
      message: 'Đề tài đã hoàn thành. Không thể chỉnh sửa checklist.',
    },
  });
}
```

### 4. Dossier Pack Type Validation
```typescript
canExportPack(packType: DossierPackType, proposal: Proposal): boolean {
  switch (packType) {
    case DossierPackType.FACULTY_ACCEPTANCE:
      return proposal.state >= ProjectState.FACULTY_ACCEPTANCE_REVIEW;
    case DossierPackType.SCHOOL_ACCEPTANCE:
      return proposal.state >= ProjectState.SCHOOL_ACCEPTANCE_REVIEW;
    case DossierPackType.HANDOVER:
      return proposal.state >= ProjectState.HANDOVER;
    case DossierPackType.FINAL:
      return proposal.state === ProjectState.COMPLETED;
  }
}
```

---

## Code Review Highlights

### Story 6.1 - 6.5 (Controller Type Casting)
- **CRITICAL #1 FIXED:** Removed unsafe `as unknown` casting in all 5 endpoints
- DTO validation now properly executed before service layer

### Story 6.1 - 6.5 (Service WorkflowAction)
- **HIGH #1 FIXED:** Use WorkflowAction enum instead of string literals
- Type safety for workflow log entries

### Story 6.3 (holderUnit Clarity)
- **MEDIUM #1 FIXED:** Added HOLDER_PHONG_KHCN constant
- Self-documenting code for null holder pattern

### Story 6.5 (Read-Only Error Message)
- **MEDIUM #2 FIXED:** Explicit error for COMPLETED state
- Follows Epic 5 Story 5.5 pattern

---

## New Information Emerged

### 1. Dual-Level Acceptance Requires Different Holder Rules
Faculty acceptance and school acceptance have different holder behaviors:
- **Faculty Accept (DAT):** holderUnit → PHONG_KHCN (null), passes to school
- **School Accept (DAT):** holderUnit → facultyId, returns to owner for handover
- **Both Reject:** holderUnit → facultyId, holderUser → ownerId, back to PI

### 2. Dossier Export Has Multiple Pack Types
Story 6.6 revealed dossier export has different access levels:
- FACULTY_ACCEPTANCE: QUAN_LY_KHOA, ADMIN
- SCHOOL_ACCEPTANCE: PHONG_KHCN, THU_KY_HOI_DONG, ADMIN
- HANDOVER: Owner, QUAN_LY_KHOA, PHONG_KHCN, ADMIN
- FINAL: Owner, QUAN_LY_KHOA, PHONG_KHCN, THU_KY_HOI_DONG, ADMIN

### 3. Handover Checklist Uses Auto-Save Pattern
Story 6.5 reused the auto-save pattern from Story 2.3:
- Draft saves to formData without state transition
- Final submission (completeHandover) transitions HANDOVER → COMPLETED

### 4. actualStartDate and completedDate Mark Project Timeline
New tracking fields:
- `actualStartDate`: Set when owner starts project (Story 6.1)
- `completedDate`: Set when owner completes handover (Story 6.5)
- Both optional DateTime fields on Proposal model

---

## Technical Debt Tracking

| Item | Story | Impact | Planned Fix | Status |
|------|-------|--------|-------------|--------|
| None identified | - | - | - | - |

---

## Action Items for Epic 7

### 1. Continue WorkflowAction Enum Pattern
Epic 7 will add new document export actions. Follow the pattern:
```typescript
import { WorkflowAction } from '@prisma/client';
action: WorkflowAction.<NEW_ACTION>
```

### 2. Continue RBAC for Document Downloads
Epic 7 will have template management and document generation. Use the RBAC pattern:
```typescript
@UseGuards(RolesGuard)
@RequireRoles(UserRole.ADMIN, UserRole.PHONG_KHCN)
```

### 3. Continue Proper DTO Mapping
When creating new endpoints, map DTOs explicitly:
```typescript
const serviceDto = {
  field1: dto.field1,
  field2: dto.field2,
  nested: dto.nested.map(n => ({ ...n })),
};
```

---

## Epic 5 Retro Follow-Through

### Action Items from Epic 5 Retro

| Action Item | Status | Evidence |
|-------------|--------|----------|
| Use Atomic Transaction Pattern | Applied | All Epic 6 methods use $transaction |
| Continue RBAC for Downloadable Content | Applied | DossierExportService has RBAC |
| Apply Read-Only Pattern After Finalization | Applied | Story 6.5 COMPLETED state read-only |

### Lessons Applied from Epic 5

1. **IdempotencyInterceptor at Controller Level**
   - Applied to ProposalsController
   - All Epic 6 endpoints benefit from idempotency protection

2. **WorkflowAction Enum Values**
   - All Epic 6 actions added to enum
   - Type-safe workflow log entries

3. **Vietnamese Localization**
   - All API errors use Vietnamese text
   - Consistent terminology across stories

---

## Next Epic Preview: Epic 7

### Epic 7: Document Export (Milestone Completion)

**Objective:** Complete and refine document export functionality + Template upload/registry + DOCX generation.

**Dependencies on Epic 6:**
1. **COMPLETED State** - Full dossier pack requires completed project
2. **Dossier Structure** - ZIP export pattern for final pack
3. **Export RBAC Pattern** - Role-based access for downloads

**Potential Risks:**
1. DOCX generation library may have limitations
2. Template placeholder validation complexity
3. Large file handling for template uploads

**Preparation Needed:**
- Choose DOCX generation library (docxtemplates? docx?)
- Design template registry schema
- Plan placeholder extraction/validation

---

## Readiness Assessment

**Testing & Quality:** Good
- All code review issues fixed
- TypeScript compilation passing
- Tests created for new components

**Deployment:** Pending
- Development environment only

**Stakeholder Acceptance:** Pending
- Pending user review

**Technical Health:** Good
- Clean code after code review fixes
- No blocking technical debt
- Patterns established for reuse

**Unresolved Blockers:** None

---

## Key Takeaways

1. **DTO Mapping Matters** - `as unknown` casting bypasses validation; always map explicitly
2. **Enum Over Strings** - Use WorkflowAction enum for type safety
3. **Multi-Level Acceptance Works** - Different holder rules at each level
4. **Dossier Export Needs RBAC** - Different pack types have different access levels
5. **Auto-Save Pattern Reusable** - Handover checklist reused Story 2.3 pattern

---

## Commitments Made Today

**Action Items:** 0
- All code review issues fixed
- No outstanding action items

**Preparation Tasks for Epic 7:** 0
- Epic 6 completion solid
- Epic 7 ready to start

**Critical Path Items:** 0
- No blockers to Epic 7 start

---

## Team Performance

Epic 6 delivered 6 stories with 5 code review fixes all resolved. The retrospective established patterns (multi-level acceptance, dossier export RBAC, auto-save checklist) that will serve Epic 7 well.

**Epic 6 Status:** Complete
**Epic 7 Readiness:** Ready to Start

---

## Retrospective Participants
- **Product Owner:** Epic requirements from PRD/Epics
- **Scrum Master:** Retrospective facilitation
- **Developer:** Implementation across 6 stories
- **Code Reviewer:** Found and fixed 5 issues

**Next Retrospective:** After Epic 7 (Document Export Completion)
