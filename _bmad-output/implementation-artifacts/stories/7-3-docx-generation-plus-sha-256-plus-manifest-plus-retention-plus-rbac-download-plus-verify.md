# Story 7.3: DOCX Generation + SHA-256 + Manifest + Retention + RBAC Download + Verify

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a GIANG_VIEN/QUAN_LY_KHOA/PKHHCN/ADMIN,
I want generate DOCX từ template với tracking integrity,
So that tôi có thể export official documents.

## Acceptance Criteria

1. **AC1: DOCX Generation Endpoint**
   - Given Proposal data + active template
   - When User request DOCX generation
   - Then system:
     - Load active template cho document type
     - Replace placeholders với proposal data
     - Generate DOCX file
     - Calculate SHA-256 hash
     - Store generated document
     - Return download link

2. **AC2: Placeholder Replacement**
   - Given Template có placeholders
   - When generate DOCX
   - Then tất cả `{{variable}}` replaced với actual values:
     - `{{proposal.code}}` → DT-001
     - `{{proposal.title}}` → "Nghiên cứu AI"
     - `{{proposal.owner}}` → "Nguyễn Văn A"
     - Table rows populated từ arrays
     - Conditional sections show/hide

3. **AC3: SHA-256 Integrity**
   - Given DOCX generated
   - When file created
   - Then calculate SHA-256 hash
   - And store hash in documents table
   - And hash displayed in document metadata

4. **AC4: Document Manifest**
   - Given DOCX generated
   - When generation completes
   - Then create manifest entry:
     - Document type
     - Template version used
     - SHA-256 hash
     - Generated timestamp
     - Generated by (user)
     - Linked proposal

5. **AC5: RBAC Download Authorization**
   - Given Document generated
   - When User attempts download
   - Then authorize based on role + ownership:
     - GIANG_VIEN: only own proposals
     - QUAN_LY_KHOA: faculty proposals
     - PHONG_KHCN: all proposals
     - ADMIN: all proposals

6. **AC6: Document Retention**
   - Given Generated documents
   - When retention policy check
   - Then documents retained cho 7 years
   - And archived documents cannot be deleted (only soft delete)

7. **AC7: Verify Integrity Action**
   - Given Document với SHA-256 hash
   - When Admin clicks "Verify Integrity"
   - Then recalculate hash
   - And compare với stored hash
   - And return VALID/MISMATCH result

8. **AC8: Generated Document List**
   - Given Proposal với generated documents
   - When User opens proposal detail
   - Then show "Documents" tab với:
     - Document type
     - Generated date
     - Generated by
     - SHA-256 hash (clickable copy)
     - Download button
     - Verify button (admin only)

## Tasks / Subtasks

- [ ] Task 1: Backend - DOCX Generation Service (AC: #1, #2)
  - [ ] Install docxtemplater library
  - [ ] Create DocxGenerationService
  - [ ] Implement loadTemplate() method
  - [ ] Implement replacePlaceholders() method
  - [ ] Handle text placeholders
  - [ ] Handle table row placeholders (arrays)
  - [ ] Handle conditional sections
  - [ ] Generate output DOCX

- [ ] Task 2: Backend - SHA-256 Integrity (AC: #3)
  - [ ] Create IntegrityService
  - [ ] Implement calculateSHA256() method
  - [ ] Store hash in documents table
  - [ ] Display hash in API response

- [ ] Task 3: Backend - Document Manifest (AC: #4)
  - [ ] Create document_manifests table
  - [ ] Implement createManifest() method
  - [ ] Log template version used
  - [ ] Log generation metadata

- [ ] Task 4: Backend - Document Generation Endpoint (AC: #1, #5)
  - [ ] Create POST /proposals/:id/generate-docx endpoint
  - [ ] Accept document_type parameter
  - [ ] Load active template for type
  - [ ] Generate DOCX with proposal data
  - [ ] Calculate SHA-256
  - [ ] Create manifest entry
  - [ ] Return download URL
  - [ ] Add RBAC guards

- [ ] Task 5: Backend - Document Download Endpoint (AC: #5)
  - [ ] Create GET /documents/:id/download endpoint
  - [ ] Verify user permissions (role + ownership)
  - [ ] Stream file to client
  - [ ] Set Content-Disposition header
  - [ ] Log download action

- [ ] Task 6: Backend - Document Retention (AC: #6)
  - [ ] Implement soft delete (deletedAt)
  - [ ] Add retention_period field
  - [ ] Prevent hard delete trong retention period
  - [ ] Archive policy enforcement

- [ ] Task 7: Backend - Verify Integrity Endpoint (AC: #7)
  - [ ] Create POST /documents/:id/verify endpoint
  - [ ] Admin-only access
  - [ ] Recalculate SHA-256
  - [ ] Compare with stored hash
  - [ ] Return validation result

- [ ] Task 8: Backend - Generated Document List (AC: #8)
  - [ ] Create GET /proposals/:id/documents endpoint
  - [ ] Return list of generated documents
  - [ ] Include metadata (type, date, hash, generator)
  - [ ] Support pagination

- [ ] Task 9: Frontend - Generate DOCX Button (AC: #1, #5)
  - [ ] Add "Tạo DOCX" button to proposal detail
  - [ ] Show dropdown for document type
  - [ ] Handle generate click
  - [ ] Show loading state
  - [ ] Handle success/error

- [ ] Task 10: Frontend - Documents Tab (AC: #8)
  - [ ] Create DocumentsTab component
  - [ ] Show document list table
  - [ ] Display metadata columns
  - [ ] Add download button
  - [ ] Add verify button (admin only)
  - [ ] Copy hash on click

- [ ] Task 11: Frontend - Verify Integrity UI (AC: #7)
  - [ ] Create VerifyIntegrityDialog component
  - [ ] Show recalculation progress
  - [ ] Display VALID/MISMATCH result
  - [ ] Admin-only visibility

- [ ] Task 12: Unit Tests (AC: #1, #2, #3, #4, #5, #6, #7, #8)
  - [ ] Test DOCX generation with template
  - [ ] Test placeholder replacement (text, tables, conditionals)
  - [ ] Test SHA-256 calculation
  - [ ] Test manifest creation
  - [ ] Test RBAC for generate
  - [ ] Test RBAC for download
  - [ ] Test verify integrity
  - [ ] Test retention policy

## Dev Notes

### Epic 7 Context

**Epic 7: Document Export (Milestone Completion)**
- FRs covered: FR33, FR36, FR37, FR38, FR39
- Story 7.1: Document Export Completion (Refinement) (done)
- Story 7.2: Template Upload & Registry (done)
- **Story 7.3: DOCX Generation + SHA-256 + Manifest (THIS STORY)** - Complete Epic 7

### Dependencies

**Depends on:**
- Story 7.1 (Document Export Completion) - File: `stories/7-1-document-export-completion-refinement.md` - Export patterns
- Story 7.2 (Template Upload & Registry) - File: `stories/7-2-template-upload-plus-registry.md` - Templates available

**Enables:**
- Complete Epic 7 deliverables
- Official DOCX document generation
- Document integrity tracking

### Epic 6 Retro Learnings to Apply

From `epic-6-retro-2026-01-07.md`:

1. **Continue Proper DTO Mapping Pattern:**
   ```typescript
   // CORRECT:
   const generateDto = {
     proposalId: proposal.id,
     documentType: dto.documentType,
     templateId: template.id,
     templateVersion: template.version,
   };
   ```

2. **Continue WorkflowAction Enum Pattern:**
   ```typescript
   import { WorkflowAction } from '@prisma/client';
   // NOTE: These action values may need to be added to the WorkflowAction enum
   // if they don't already exist. Check project-context.md for the full enum definition.
   action: WorkflowAction.DOC_GENERATED
   action: WorkflowAction.DOC_DOWNLOADED
   action: WorkflowAction.DOC_VERIFIED
   ```

3. **Continue Atomic Transaction Pattern:**
   ```typescript
   return this.prisma.$transaction(async (tx) => {
     // 1. Generate DOCX file
     // 2. Calculate SHA-256
     // 3. Create document record
     // 4. Create manifest entry
     // 5. Log workflow action
     // Return document
   });
   ```

4. **Continue RBAC for Document Downloads:**
   ```typescript
   @UseGuards(JwtAuthGuard)
   @Get(':id/download')
   async download(
     @Param('id') id: string,
     @CurrentUser() user: User,
     @Res() res: Response
   ) {
     const doc = await this.prisma.document.findUnique({
       where: { id },
       include: { proposal: true },
     });

     // RBAC check
     const isAdmin = user.role === UserRole.ADMIN;
     const isOwner = doc.proposal.ownerId === user.id;
     const isFaculty = user.role === UserRole.QUAN_LY_KHOA && user.facultyId === doc.proposal.facultyId;
     const isPKHCN = user.role === UserRole.PHONG_KHCN;

     if (!isAdmin && !isOwner && !isFaculty && !isPKHCN) {
       throw new ForbiddenException('Bạn không có quyền tải tài liệu này');
     }
   }
   ```

### Project Structure Notes

**Backend Structure:**
```
qlnckh/apps/src/modules/
  documents/
    documents.controller.ts   # New: Document endpoints
    documents.service.ts      # New: Document management
    dto/
      generate-doc.dto.ts     # New: Generate DTO
      document.dto.ts         # New: Document response DTO
    documents.module.ts       # New: Module definition
  docx/
    docx.service.ts           # New: DOCX generation
    integrity.service.ts      # New: SHA-256 integrity
    placeholder-replacer.ts   # New: Placeholder logic
  templates/
    templates.service.ts      # Extend: Get active template
```

**Frontend Structure:**
```
qlnckh/web-apps/src/
  components/
    proposal/
      DocumentsTab.tsx        # New: Documents list
      GenerateDocxButton.tsx  # New: Generate button
      VerifyIntegrityDialog.tsx # New: Verify dialog
  lib/api/
    documents.ts              # New: Document API
    docx.ts                   # New: DOCX generation API
```

### Architecture Compliance

**Database Schema:**
```prisma
// NOTE: DocumentTemplate model is defined in Story 7.2
// with `documents Document[]` back-relation already added.
// The `version` field is also defined in Story 7.2.

model Document {
  id              String         @id @default(uuid())
  proposalId      String
  documentType    DocumentType
  templateId      String
  templateVersion Int            // References DocumentTemplate.version
  filePath        String
  fileName        String
  fileSize        Int
  sha256Hash      String         @unique
  generatedBy     String
  generatedAt     DateTime       @default(now())
  deletedAt       DateTime?
  retentionUntil  DateTime?

  proposal        Proposal       @relation(fields: [proposalId])
  template        DocumentTemplate @relation(fields: [templateId])
  manifest        DocumentManifest?

  @@index([proposalId])
  @@index([sha256Hash])
  @@index([deletedAt])
}

model DocumentManifest {
  id              String   @id @default(uuid())
  documentId      String   @unique
  templateId      String
  templateVersion Int
  proposalData    Json     // Snapshot of proposal data
  generatedBy     String
  generatedAt     DateTime
  verifiedAt      DateTime?
  verifiedBy      String?
  verificationResult String? // 'VALID' | 'MISMATCH'

  document        Document @relation(fields: [documentId])

  @@index([documentId])
}

enum DocumentType {
  PROPOSAL_OUTLINE
  EVALUATION_FORM
  FINAL_REPORT
  FACULTY_ACCEPTANCE
  SCHOOL_ACCEPTANCE
  HANDOVER_CHECKLIST
}
```

**NPM Dependencies:**
```bash
npm install docxtemplater pizzip
npm install -D @types/pizzip
```

**DOCX Generation Service:**
```typescript
import Docxtemplater from 'docxtemplater';
import PizZip from 'pizzip';

@Injectable()
export class DocxService {
  async generateFromTemplate(
    template: DocumentTemplate,
    data: ProposalData,
  ): Promise<Buffer> {
    // Load template
    const content = await this.fileService.readFile(template.filePath);
    const zip = new PizZip(content);

    // Replace placeholders
    const doc = new Docxtemplater(zip, {
      paragraphLoop: true,
      linebreaks: true,
    });

    doc.render(this.buildDataMap(data));

    // Generate output
    return doc.getZip().generate({
      type: 'nodebuffer',
      compression: 'DEFLATE',
    });
  }

  private buildDataMap(data: ProposalData): Record<string, any> {
    return {
      proposal: {
        code: data.code,
        title: data.title,
        owner: data.ownerName,
        faculty: data.facultyName,
      },
      evaluation: {
        council: data.councilName,
        secretary: data.secretaryName,
        decision: data.decision,
        date: formatDate(data.evaluationDate),
      },
      // ... more mappings
    };
  }
}
```

**Placeholder Replacement Patterns:**
```typescript
// Text placeholder: {{proposal.title}}
// Table row placeholder: {{#products}} ... {{/products}}
// Conditional section: {{#hasAttachments}} ... {{/hasAttachments}}

const dataMap = {
  proposal: {
    code: 'DT-001',
    title: 'Nghiên cứu AI',
  },
  products: [
    { name: 'Báo cáo', type: 'PDF' },
    { name: 'Source code', type: 'GitHub' },
  ],
  hasAttachments: true, // Shows/hides conditional section
};
```

**SHA-256 Integrity:**
```typescript
import { createHash } from 'crypto';

@Injectable()
export class IntegrityService {
  calculateSHA256(buffer: Buffer): string {
    return createHash('sha256')
      .update(buffer)
      .digest('hex');
  }

  async verify(documentId: string): Promise<VerificationResult> {
    const doc = await this.prisma.document.findUnique({
      where: { id: documentId },
    });

    const content = await this.fileService.readFile(doc.filePath);
    const currentHash = this.calculateSHA256(content);

    return {
      valid: currentHash === doc.sha256Hash,
      storedHash: doc.sha256Hash,
      currentHash,
    };
  }
}
```

**RBAC Authorization Matrix:**
```typescript
// Document Download Authorization
const canDownload = (user: User, proposal: Proposal): boolean => {
  switch (user.role) {
    case UserRole.ADMIN:
      return true;
    case UserRole.PHONG_KHCN:
      return true;
    case UserRole.QUAN_LY_KHOA:
      return user.facultyId === proposal.facultyId;
    case UserRole.GIANG_VIEN:
      return proposal.ownerId === user.id;
    default:
      return false;
  }
};
```

### Data Model

**Generate DOCX DTO:**
```typescript
export class GenerateDocDto {
  @IsEnum(DocumentType)
  documentType: DocumentType;

  @IsOptional()
  @IsString()
  templateId?: string; // Override active template
}
```

**Document Response DTO:**
```typescript
export class DocumentResponseDto {
  id: string;
  proposalId: string;
  documentType: DocumentType;
  fileName: string;
  fileSize: number;
  sha256Hash: string;
  generatedBy: string;
  generatedAt: Date;
  downloadUrl: string;
}
```

**Verification Result DTO:**
```typescript
export class VerificationResultDto {
  valid: boolean;
  storedHash: string;
  currentHash: string;
  verifiedAt: Date;
  verifiedBy: string;
}
```

### Testing Standards

**Backend Tests:**
- Test DOCX generation with all placeholder types
- Test table row generation
- Test conditional sections
- Test SHA-256 calculation
- Test integrity verification
- Test RBAC for generate/download
- Test retention policy enforcement
- Test manifest creation

**Frontend Tests:**
- Test generate button visibility
- Test document type dropdown
- Test documents tab display
- Test download button
- Test verify button (admin only)
- Test hash copy on click

**Integration Tests:**
- Test full flow: upload template → generate → download → verify
- Test placeholder replacement with real proposal data
- Test multi-table row generation

### Vietnamese Localization

All UI text must be in Vietnamese:
- "Tạo DOCX" (Generate DOCX)
- "Đang tạo tài liệu..." (Generating document...)
- "Tài liệu đã tạo" (Documents generated)
- "Loại tài liệu" (Document type)
- "Ngày tạo" (Created date)
- "Người tạo" (Created by)
- "Mã băm SHA-256" (SHA-256 hash)
- "Tải xuống" (Download)
- "Xác thực tính toàn vẹn" (Verify integrity)
- "Hợp lệ" (Valid)
- "Không khớp" (Mismatch)
- "Bạn không có quyền tải tài liệu này" (No permission)

### Code Patterns to Follow

**From Epic 6 Retro:**
- Proper DTO mapping (no `as unknown`)
- WorkflowAction enum for all actions
- Atomic transactions for state changes
- RBAC guards on all endpoints

**DOCX Generation Pattern:**
```typescript
async generateDocx(
  proposalId: string,
  dto: GenerateDocDto,
  user: User,
): Promise<DocumentResponseDto> {
  return this.prisma.$transaction(async (tx) => {
    // 1. Get proposal data
    const proposal = await this.getProposalWithDetails(proposalId);

    // 2. Get active template
    const template = await this.getTemplateForType(dto.documentType);

    // 3. Generate DOCX
    const docxBuffer = await this.docxService.generateFromTemplate(
      template,
      proposal,
    );

    // 4. Calculate SHA-256
    const sha256Hash = this.integrityService.calculateSHA256(docxBuffer);

    // 5. Save file
    const fileName = `${proposal.code}_${dto.documentType}_${Date.now()}.docx`;
    const filePath = await this.fileService.saveFile(fileName, docxBuffer);

    // 6. Create document record
    const document = await tx.document.create({
      data: {
        proposalId,
        documentType: dto.documentType,
        templateId: template.id,
        templateVersion: template.version,
        filePath,
        fileName,
        fileSize: docxBuffer.length,
        sha256Hash,
        generatedBy: user.id,
        retentionUntil: new Date(Date.now() + 7 * 365 * 24 * 60 * 60 * 1000), // 7 years
      },
    });

    // 7. Create manifest
    await tx.documentManifest.create({
      data: {
        documentId: document.id,
        templateId: template.id,
        templateVersion: template.version,
        proposalData: proposal,
        generatedBy: user.id,
        generatedAt: new Date(),
      },
    });

    // 8. Log workflow
    await this.workflowService.logAction({
      entityType: 'document',
      entityId: document.id,
      action: WorkflowAction.DOC_GENERATED,
      actorId: user.id,
      actorRole: user.role,
    });

    return this.toDto(document);
  });
}
```

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### Completion Notes List

Story 7-3 created via create-story workflow. Status: ready-for-dev
- Epic 6 retrospective learnings applied (DTO mapping, WorkflowAction enum, atomic transactions, RBAC)
- DOCX generation service designed
- SHA-256 integrity tracking
- Document manifest for versioning
- RBAC authorization matrix
- 7-year retention policy
- Integrity verification endpoint
- Complete Epic 7 deliverables

### File List

**To Create:**
- `qlnckh/apps/src/modules/documents/documents.controller.ts` - Document endpoints
- `qlnckh/apps/src/modules/documents/documents.service.ts` - Document management
- `qlnckh/apps/src/modules/documents/dto/generate-doc.dto.ts` - Generate DTO
- `qlnckh/apps/src/modules/documents/dto/document.dto.ts` - Response DTO
- `qlnckh/apps/src/modules/documents/dto/index.ts` - Barrel export
- `qlnckh/apps/src/modules/documents/documents.module.ts` - Module definition
- `qlnckh/apps/src/modules/docx/docx.service.ts` - DOCX generation
- `qlnckh/apps/src/modules/docx/integrity.service.ts` - SHA-256 integrity
- `qlnckh/apps/src/modules/docx/placeholder-replacer.ts` - Placeholder logic
- `qlnckh/apps/src/modules/docx/docx.module.ts` - Module definition
- `qlnckh/web-apps/src/components/proposal/DocumentsTab.tsx` - Documents list
- `qlnckh/web-apps/src/components/proposal/GenerateDocxButton.tsx` - Generate button
- `qlnckh/web-apps/src/components/proposal/VerifyIntegrityDialog.tsx` - Verify dialog
- `qlnckh/web-apps/src/lib/api/documents.ts` - Document API
- `qlnckh/web-apps/src/lib/api/docx.ts` - DOCX generation API

**To Modify:**
- `qlnckh/apps/src/app.module.ts` - Import DocumentsModule, DocxModule
- `qlnckh/prisma/schema.prisma` - Add Document, DocumentManifest tables
- `qlnckh/apps/src/modules/templates/templates.service.ts` - Extend for template lookup
- `qlnckh/package.json` - Add docxtemplater, pizzip dependencies
- `_bmad-output/implementation-artifacts/sprint-status.yaml` - Update story status

## Change Log

- 2026-01-07: Story created via create-story workflow. Status: ready-for-dev
  - Epic 6 context analyzed from epics.md
  - Epic 6 retrospective learnings incorporated
  - Proper DTO mapping pattern specified
  - WorkflowAction enum pattern specified
  - Atomic transaction pattern specified
  - RBAC authorization matrix defined
  - DOCX generation service designed
  - SHA-256 integrity tracking
  - Document manifest for versioning
  - 7-year retention policy
  - Integrity verification endpoint
  - Complete Epic 7 deliverables
  - Comprehensive developer guide created
  - Ready for dev-story workflow execution

## References

- [epics.md Story 7.3](../../planning-artifacts/epics.md#L2007-L2089) - Full requirements
- [epic-6-retro-2026-01-07.md](../../implementation-artifacts/retrospectives/epic-6-retro-2026-01-07.md) - Lessons learned
- [architecture.md](../../planning-artifacts/architecture.md) - State machine & patterns
- [project-context.md](../../project-context.md) - Implementation rules
- [Story 7.1](./7-1-document-export-completion-refinement.md) - Export patterns
- [Story 7.2](./7-2-template-upload-plus-registry.md) - Template management
