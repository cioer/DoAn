4.4. CÀI ĐẶT FORM ENGINE
4.4.1. Kiến trúc Form Engine
Form Engine là microservice Python độc lập chạy trên cổng 8080, sử dụng FastAPI phiên bản 0.109.2 làm web framework và Uvicorn làm ASGI server.
Kiến trúc bao gồm lớp API nhận request từ backend NestJS, lớp Service xử lý logic tạo tài liệu, lớp Template Manager quản lý các mẫu Word, và lớp Converter chuyển đổi sang PDF.
Lý do tách Form Engine thành microservice riêng là việc tạo PDF tiêu tốn nhiều CPU và có thể mất 10 đến 15 giây. Nếu để chung với backend, khi có nhiều yêu cầu đồng thời, toàn bộ API sẽ bị chậm.
Lý do chọn Python là thư viện python-docx xử lý file Word tốt hơn nhiều so với các thư viện Node.js. Việc tích hợp LibreOffice cũng dễ dàng hơn trong môi trường Python.
4.4.2. Quản lý mẫu biểu mẫu
Hệ thống có 18 loại biểu mẫu từ FORM_1B đến FORM_18B và các phụ lục PL1, PL2, PL3. Mỗi mẫu là file Word với các placeholder được đánh dấu bằng cú pháp đặc biệt.
Mẫu biểu mẫu theo giai đoạn bao gồm giai đoạn 1 Đề xuất với FORM_1B phiếu đề xuất và FORM_PL1 thuyết minh chi tiết, giai đoạn 2 Duyệt Khoa với FORM_2B phiếu đánh giá và FORM_3B biên bản họp và FORM_4B tổng hợp, giai đoạn 3 Chọn Trường với FORM_5B phiếu sơ tuyển, giai đoạn 4 Xét đề cương với FORM_6B biên bản Hội đồng và FORM_7B báo cáo đề cương, giai đoạn 5 Nghiệm thu Khoa với FORM_8B đến FORM_11B và FORM_PL2 báo cáo tổng kết, giai đoạn 6 Nghiệm thu Trường với FORM_12B đến FORM_16B và FORM_PL3 phản biện chi tiết, giai đoạn 7 Bàn giao với FORM_17B biên bản bàn giao, và biểu mẫu đặc biệt FORM_18B xin gia hạn.
Mỗi mẫu được lưu trong thư mục templates với tên file theo quy ước loại biểu mẫu. Khi cần tạo tài liệu, service đọc mẫu tương ứng và điền dữ liệu vào các placeholder.
4.4.3. Xử lý placeholder và merge dữ liệu
Placeholder trong mẫu Word sử dụng cú pháp Jinja2 với dấu ngoặc nhọn kép. Các placeholder đơn giản như tên đề tài được viết dạng hai ngoặc nhọn mở, tên biến, hai ngoặc nhọn đóng.
python-docx phiên bản 1.1.0 được sử dụng để đọc file Word, tìm các placeholder, và thay thế bằng dữ liệu thực tế. Thư viện này giữ nguyên định dạng của mẫu như font chữ, kích thước, in đậm, và căn lề.
Các placeholder phức tạp như danh sách thành viên sử dụng vòng lặp for trong template. Bảng động được xử lý bằng cách thêm dòng vào bảng hiện có.
Sau khi merge dữ liệu, file Word kết quả được lưu với tên chứa id đề tài và timestamp để đảm bảo duy nhất.
4.4.4. Chuyển đổi Word sang PDF
LibreOffice phiên bản 7 được cài đặt trong Docker image để chuyển đổi Word sang PDF. Chế độ headless cho phép chạy mà không cần giao diện đồ họa.
Lệnh chuyển đổi sử dụng soffice với tham số headless và convert-to pdf. File Word đầu vào được chỉ định và file PDF đầu ra được lưu vào thư mục output.
Quá trình chuyển đổi mất từ 5 đến 15 giây tùy độ phức tạp của file. Hệ thống đặt timeout 60 giây để tránh treo vô hạn nếu LibreOffice gặp lỗi.
Lý do dùng LibreOffice thay vì các thư viện Python là LibreOffice cho kết quả chính xác nhất, giữ nguyên định dạng như font, bảng, và hình ảnh. Các thư viện Python thường mất định dạng phức tạp.
4.4.5. API endpoints của Form Engine
Endpoint GET /api/v1/health trả về trạng thái healthy để Docker kiểm tra service còn hoạt động.
Endpoint POST /api/v1/documents/generate nhận dữ liệu JSON gồm templateType loại biểu mẫu, proposalData dữ liệu đề tài, và outputFormat là docx hoặc pdf. Trả về file kết quả hoặc đường dẫn file trên server.
Endpoint GET /api/v1/templates liệt kê các mẫu biểu mẫu có sẵn với thông tin tên và các placeholder yêu cầu.
Endpoint POST /api/v1/templates/upload cho phép upload mẫu mới hoặc cập nhật mẫu hiện có.
4.4.6. Xử lý lỗi và logging
Mọi request được log với thông tin thời gian, loại biểu mẫu, kích thước dữ liệu, và thời gian xử lý. Log được lưu vào thư mục logs và rotate hàng ngày.
Khi có lỗi, hệ thống trả về mã lỗi HTTP phù hợp như 400 cho dữ liệu không hợp lệ, 404 cho mẫu không tồn tại, và 500 cho lỗi server. Response chứa thông báo lỗi chi tiết giúp debug.
Lỗi LibreOffice timeout được xử lý đặc biệt với thông báo yêu cầu thử lại sau. File tạm được dọn dẹp để tránh đầy ổ đĩa.
4.4.7. Tối ưu hiệu năng
Connection pool được sử dụng khi gọi LibreOffice để tránh khởi động lại process mỗi lần chuyển đổi. LibreOffice được giữ chạy ngầm và nhận lệnh qua socket.
File kết quả được cache trong thời gian ngắn. Nếu cùng một yêu cầu được gọi lại trong vòng 5 phút, trả về file đã tạo thay vì tạo lại.
Async processing với aiofiles cho phép đọc ghi file không chặn, tận dụng tốt hơn tài nguyên khi có nhiều request đồng thời.
Lý do cần tối ưu là Form Engine là điểm nghẽn của hệ thống. Nếu mỗi request mất 15 giây và chỉ xử lý tuần tự, 10 request sẽ mất 150 giây. Với tối ưu, thời gian giảm đáng kể.
