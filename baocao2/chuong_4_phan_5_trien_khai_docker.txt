4.5. TRIỂN KHAI VỚI DOCKER
4.5.1. Tổng quan kiến trúc Docker
Hệ thống được đóng gói thành nhiều container Docker và quản lý bằng Docker Compose. Mỗi thành phần chạy trong container riêng biệt, giao tiếp qua mạng nội bộ Docker.
Các container bao gồm backend NestJS chạy trên cổng 4000, frontend React được serve bởi Nginx trên cổng 80, PostgreSQL phiên bản 15-alpine trên cổng 5432, và Form Engine Python trên cổng 8080.
Lý do dùng Docker là đảm bảo môi trường nhất quán. Không còn tình trạng chạy được trên máy phát triển nhưng lỗi trên server sản xuất vì khác phiên bản thư viện.
Lý do dùng Docker Compose là quản lý nhiều container dễ dàng. Một lệnh docker-compose up khởi động toàn bộ hệ thống với đúng cấu hình mạng và volume.
4.5.2. Cấu hình PostgreSQL
Container PostgreSQL sử dụng image postgres:15-alpine, image chính thức với kích thước nhỏ gọn. Cấu hình bao gồm tên database là qlnckh, user là qlnckh, và password được đặt trong file environment.
Volume postgres_data được mount để dữ liệu không bị mất khi container restart. Thư mục /var/lib/postgresql/data trong container được ánh xạ với volume trên host.
Health check được cấu hình với lệnh pg_isready để Docker biết khi nào database sẵn sàng nhận kết nối. Các container khác chờ database healthy trước khi khởi động.
Lý do dùng volume thay vì lưu trong container là container có thể bị xóa và tạo lại khi update. Volume giữ dữ liệu an toàn qua các lần deploy.
4.5.3. Cấu hình Backend
Dockerfile cho backend sử dụng image node:20-alpine làm base. Quá trình build gồm hai giai đoạn, giai đoạn build cài dependencies và compile TypeScript, giai đoạn production chỉ copy file đã build và dependencies cần thiết.
Biến môi trường bao gồm DATABASE_URL chứa connection string đến PostgreSQL, JWT_SECRET cho mã hóa token, và FORM_ENGINE_URL chứa địa chỉ Form Engine service.
Container backend phụ thuộc vào container database và chờ database healthy trước khi khởi động. Lệnh khởi động chạy migration Prisma rồi start ứng dụng NestJS.
Lý do dùng multi-stage build là giảm kích thước image cuối cùng. Image chỉ chứa code đã compile và runtime dependencies, không chứa devDependencies và source code.
4.5.4. Cấu hình Frontend
Dockerfile cho frontend cũng sử dụng multi-stage build. Giai đoạn build dùng node:20-alpine để chạy npm run build với Vite. Giai đoạn production dùng nginx:alpine để serve file tĩnh.
File nginx.conf cấu hình Nginx làm reverse proxy. Request đến /api được proxy đến container backend. Request khác được serve từ thư mục build của React. Cấu hình try_files đảm bảo client-side routing hoạt động đúng.
Gzip compression được bật để giảm kích thước response. Cache headers được đặt cho file tĩnh như JavaScript và CSS để trình duyệt cache và không tải lại mỗi lần.
Lý do dùng Nginx thay vì Node.js serve file tĩnh là Nginx được tối ưu cho việc này với hiệu năng cao hơn nhiều và ít tốn tài nguyên hơn.
4.5.5. Cấu hình Form Engine
Dockerfile cho Form Engine sử dụng python:3.10-slim làm base. Các bước cài đặt bao gồm cài LibreOffice từ apt, cài các font cần thiết như Liberation và DejaVu để PDF hiển thị đúng tiếng Việt, và cài Python dependencies từ requirements.txt.
Volume được mount cho thư mục templates chứa mẫu biểu mẫu, thư mục output chứa file đã tạo, và thư mục logs chứa log hoạt động.
Health check gọi đến endpoint /api/v1/health mỗi 30 giây để đảm bảo service hoạt động. Nếu health check thất bại 3 lần liên tiếp, Docker tự động restart container.
Lý do cài font đặc biệt là đảm bảo PDF hiển thị đúng tiếng Việt với dấu. Nếu thiếu font, các ký tự có dấu sẽ bị thay bằng ô vuông hoặc dấu hỏi.
4.5.6. Cấu hình mạng Docker
Docker Compose tạo network qlnckh-network cho phép các container giao tiếp với nhau qua tên service thay vì IP address.
Backend gọi database bằng hostname postgres thay vì localhost hoặc IP cụ thể. Tương tự, backend gọi Form Engine bằng hostname form-engine.
Chỉ các port cần thiết được expose ra ngoài. Port 80 cho Nginx phục vụ người dùng cuối, port 5432 có thể mở cho công cụ quản lý database nếu cần.
Lý do dùng tên service thay vì IP là IP của container có thể thay đổi mỗi khi restart. Tên service được Docker DNS giải quyết tự động và luôn đúng.
4.5.7. Quản lý secrets và biến môi trường
File .env chứa các biến môi trường nhạy cảm như mật khẩu database, JWT secret, và API key. File này không được commit vào Git.
Docker Compose đọc biến từ file .env và truyền vào container. Trong môi trường production, có thể sử dụng Docker secrets hoặc hệ thống quản lý secret bên ngoài như Vault.
Các giá trị mặc định được đặt trong docker-compose.yml cho môi trường development để developer mới có thể chạy ngay mà không cần cấu hình.
Lý do tách biến môi trường là cùng một code có thể chạy ở nhiều môi trường khác nhau như development, staging, production chỉ bằng cách đổi biến môi trường.
4.5.8. Quy trình deploy và update
Quy trình deploy bắt đầu bằng pull code mới từ Git, build image với docker-compose build, dừng container cũ và khởi động container mới với docker-compose up -d.
Migration database được chạy tự động khi backend khởi động. Prisma kiểm tra và áp dụng các migration chưa chạy.
Rollback thực hiện bằng cách chỉ định tag image cũ trong docker-compose.yml và restart container. Dữ liệu trong volume không bị ảnh hưởng.
Lý do cần quy trình deploy rõ ràng là giảm thiểu downtime và lỗi khi update. Mỗi bước được kiểm tra trước khi chuyển sang bước tiếp theo.
