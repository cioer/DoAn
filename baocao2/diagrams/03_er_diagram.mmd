erDiagram
    %% ER Diagram - 21 Tables
    %% Hệ thống qlNCKH - Cơ sở dữ liệu PostgreSQL

    %% ========================================
    %% CORE: Users & Authentication
    %% ========================================

    User ||--o{ RefreshToken : "has"
    User ||--|| Faculty : "belongs to"
    User ||--o{ Proposal : "owns"
    User ||--o{ Proposal : "rejects"
    User ||--o{ AuditEvent : "performs"
    User ||--o{ AuditEvent : "acts as"
    User ||--o{ Council : "secretaries"
    User ||--o{ CouncilMember : "is member"
    User ||--o{ Evaluation : "evaluates"

    User {
        uuid id PK
        string email UK
        string passwordHash
        string displayName
        enum role "GIANG_VIEN, QUAN_LY_KHOA, etc."
        uuid facultyId FK
        datetime createdAt
        datetime updatedAt
        datetime deletedAt "Soft delete"
    }

    RefreshToken {
        uuid id PK
        string token UK
        uuid userId FK
        datetime expiresAt
        datetime createdAt
        datetime revokedAt
    }

    RolePermission {
        uuid id PK
        enum role
        enum permission
        datetime createdAt
    }

    AuditEvent {
        uuid id PK
        datetime occurredAt
        uuid actorUserId FK
        uuid actingAsUserId FK
        string action
        string entityType
        string entityId
        json metadata
        string ip
        string userAgent
        string requestId
    }

    %% ========================================
    %% ORGANIZATION: Faculties
    %% ========================================

    Faculty ||--o{ User : "has"
    Faculty ||--o{ Proposal : "owns"

    Faculty {
        uuid id PK
        string code UK "FAC-001"
        string name
        enum type "FACULTY, DEPARTMENT"
        datetime createdAt
        datetime updatedAt
    }

    %% ========================================
    %% WORKFLOW: Proposals
    %% ========================================

    Proposal ||--o{ WorkflowLog : "has"
    Proposal ||--o{ Attachment : "has"
    Proposal ||--o{ Evaluation : "has"
    Proposal ||--o{ Document : "generates"
    Proposal ||--o{ ProposalDocument : "has"
    Proposal }o--|| FormTemplate : "uses template"
    Proposal }o--|| Council : "assigned to"

    Proposal {
        uuid id PK
        string code UK "DT-001"
        string title
        enum state "DRAFT, FACULTY_REVIEW, etc."
        uuid ownerId FK
        uuid facultyId FK
        uuid councilId FK
        string holderUnit
        string holderUser
        datetime slaStartDate
        datetime slaDeadline
        datetime actualStartDate
        datetime completedDate
        uuid templateId FK
        string templateVersion
        json formData
        datetime cancelledAt
        datetime withdrawnAt
        datetime rejectedAt
        uuid rejectedById FK
        datetime pausedAt
        datetime resumedAt
        string pauseReason
        datetime expectedResumeAt
        enum prePauseState
        string prePauseHolderUnit
        string prePauseHolderUser
        datetime createdAt
        datetime updatedAt
        datetime deletedAt "Soft delete"
    }

    WorkflowLog {
        uuid id PK
        uuid proposalId FK
        enum action
        enum fromState
        enum toState
        string actorId
        string actorName
        enum returnTargetState
        string returnTargetHolderUnit
        string reasonCode
        string comment
        datetime timestamp
    }

    %% ========================================
    %% FORMS: Form Templates
    %% ========================================

    FormTemplate ||--o{ FormSection : "has"
    FormTemplate ||--o{ Proposal : "used by"

    FormTemplate {
        uuid id PK
        string code UK "MAU_01B"
        string name
        string version
        string description
        boolean isActive
        string projectType
        datetime createdAt
        datetime updatedAt
    }

    FormSection {
        uuid id PK
        uuid templateId FK
        enum sectionId "SEC_INFO_GENERAL, etc."
        string label
        string component
        int displayOrder
        boolean isRequired
        json config
        datetime createdAt
        datetime updatedAt
    }

    %% ========================================
    %% CALENDAR: Business Calendar
    %% ========================================

    BusinessCalendar {
        uuid id PK
        date date UK
        string name
        boolean isHoliday
        boolean isWorkingDay
        boolean recurring
        datetime createdAt
        datetime updatedAt
    }

    %% ========================================
    %% COUNCILS: Council Management
    %% ========================================

    Council ||--o{ CouncilMember : "has"
    Council ||--o{ Proposal : "reviews"

    Council {
        uuid id PK
        string name
        enum type "OUTLINE, ACCEPTANCE"
        uuid secretaryId FK
        datetime createdAt
        datetime updatedAt
    }

    CouncilMember {
        uuid id PK
        uuid councilId FK
        uuid userId FK
        enum role "CHAIR, SECRETARY, MEMBER"
        datetime createdAt
    }

    %% ========================================
    %% DOCUMENTS: Document Templates & Generation
    %% ========================================

    DocumentTemplate ||--o{ Document : "generates"

    DocumentTemplate {
        uuid id PK
        string name
        string description
        enum templateType
        string filePath
        string fileName
        int fileSize
        string sha256Hash
        int version
        array placeholders
        boolean isActive
        string createdBy
        datetime createdAt
        datetime updatedAt
        datetime deletedAt
    }

    Document ||--|| DocumentManifest : "has"

    Document {
        uuid id PK
        uuid proposalId FK
        enum documentType
        uuid templateId FK
        int templateVersion
        string filePath
        string fileName
        int fileSize
        string sha256Hash UK
        string generatedBy
        datetime generatedAt
        datetime deletedAt
        datetime retentionUntil
    }

    DocumentManifest {
        uuid id PK
        uuid documentId FK UK
        uuid templateId
        int templateVersion
        json proposalData
        string generatedBy
        datetime generatedAt
        datetime verifiedAt
        string verifiedBy
        string verificationResult
    }

    %% ========================================
    %% EVALUATIONS: Council Evaluation
    %% ========================================

    Evaluation {
        uuid id PK
        uuid proposalId FK
        uuid evaluatorId FK
        enum state "DRAFT, FINALIZED"
        json formData
        datetime createdAt
        datetime updatedAt
    }

    %% ========================================
    %% ATTACHMENTS: Proposal Attachments
    %% ========================================

    Attachment {
        uuid id PK
        uuid proposalId FK
        string fileName
        string fileUrl
        int fileSize
        string mimeType
        string type "GENERAL, FACULTY_ACCEPTANCE, etc."
        string uploadedBy
        datetime uploadedAt
        datetime deletedAt
    }

    %% ========================================
    %% FORM ENGINE: Proposal Documents
    %% ========================================

    ProposalDocument {
        uuid id PK
        uuid proposalId FK
        enum formType "FORM_1B - FORM_18B"
        enum status "DRAFT, PENDING, APPROVED, etc."
        int version
        string filePath
        string fileName
        int fileSize
        string sha256Hash
        json formData
        string createdBy
        datetime createdAt
        datetime updatedAt
        string approvedBy
        datetime approvedAt
        string rejectedBy
        datetime rejectedAt
        string rejectionReason
        datetime deletedAt
    }
