graph LR
    %% CI/CD Pipeline - GitHub Actions
    %% Automated Testing & Deployment

    subgraph Trigger["ğŸ”” TRIGGERS"]
        Push["git push<br/>(main, develop)"]
        PR["Pull Request<br/>(to main)"]
        Manual["Manual Trigger<br/>(workflow_dispatch)"]
    end

    subgraph Pipeline["âš™ï¸ GITHUB ACTIONS PIPELINE"]
        direction TB

        subgraph Stage1["ğŸ“‹ Stage 1: CODE QUALITY"]
            Checkout1["Checkout Code"]
            Lint["ESLint & Prettier<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Check TypeScript syntax<br/>â€¢ Enforce code style<br/>â€¢ Exit on errors"]
            TypeCheck["TypeScript Check<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ tsc --noEmit<br/>â€¢ Verify type safety"]
        end

        subgraph Stage2["ğŸ§ª Stage 2: TESTING"]
            UnitTest["Unit Tests<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Vitest<br/>â€¢ 150+ test cases<br/>â€¢ Coverage: 75%<br/>â€¢ Fail if < 70%"]
            E2ETest["E2E Tests<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Playwright<br/>â€¢ 20+ scenarios<br/>â€¢ Test all workflows"]
        end

        subgraph Stage3["ğŸ—ï¸ Stage 3: BUILD"]
            BuildBackend["Build Backend<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ nx build apps<br/>â€¢ Output: dist/apps"]
            BuildFrontend["Build Frontend<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ nx build web-apps<br/>â€¢ Vite bundle<br/>â€¢ Output: dist/apps/web-apps"]
            BuildFormEngine["Build Form Engine<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ pip install<br/>â€¢ Docker image"]
        end

        subgraph Stage4["ğŸ³ Stage 4: DOCKER"]
            DockerBuild["Build Docker Images<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ backend:latest<br/>â€¢ frontend:latest<br/>â€¢ form-engine:latest"]
            DockerPush["Push to Registry<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Docker Hub<br/>â€¢ GitHub Container Registry"]
        end

        subgraph Stage5["ğŸš€ Stage 5: DEPLOYMENT"]
            DeployDev["Deploy to DEV<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Auto on push to develop<br/>â€¢ docker-compose up -d"]
            DeployProd["Deploy to PROD<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Manual approval<br/>â€¢ Blue-green deployment<br/>â€¢ Health check"]
        end

        subgraph Stage6["âœ… Stage 6: VERIFICATION"]
            HealthCheck["Health Check<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ GET /health<br/>â€¢ Verify all services"]
            SmokeTest["Smoke Tests<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Login test<br/>â€¢ Create proposal test"]
            Notify["Notifications<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Email on failure<br/>â€¢ Slack notification"]
        end

        %% Flow
        Checkout1 --> Lint
        Lint --> TypeCheck
        TypeCheck --> UnitTest
        UnitTest --> E2ETest
        E2ETest --> BuildBackend
        E2ETest --> BuildFrontend
        E2ETest --> BuildFormEngine
        BuildBackend --> DockerBuild
        BuildFrontend --> DockerBuild
        BuildFormEngine --> DockerBuild
        DockerBuild --> DockerPush
        DockerPush --> DeployDev
        DeployDev --> HealthCheck
        DockerPush -.->|Manual Approval| DeployProd
        DeployProd --> HealthCheck
        HealthCheck --> SmokeTest
        SmokeTest --> Notify
    end

    subgraph Artifacts["ğŸ“¦ BUILD ARTIFACTS"]
        Dist["â€¢ dist/apps (Backend)"]
        DistWeb["â€¢ dist/apps/web-apps (Frontend)"]
        Coverage["â€¢ coverage/ (Test reports)"]
        Docker["â€¢ Docker images"]
    end

    subgraph Environments["ğŸŒ ENVIRONMENTS"]
        Dev["DEV Environment<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Auto-deploy on push<br/>â€¢ https://dev.qlnckh.local"]
        Staging["STAGING Environment<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Manual trigger<br/>â€¢ QA testing"]
        Prod["PRODUCTION Environment<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Manual approval<br/>â€¢ https://qlnckh.local"]
    end

    %% Trigger Flow
    Push --> Pipeline
    PR --> Pipeline
    Manual --> Pipeline

    %% Deployment Flow
    DeployDev -.-> Dev
    DeployProd -.-> Prod

    %% Styling
    classDef triggerStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef stageStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef buildStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef deployStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef envStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px

    class Push,PR,Manual triggerStyle
    class Checkout1,Lint,TypeCheck stageStyle
    class UnitTest,E2ETest stageStyle
    class BuildBackend,BuildFrontend,BuildFormEngine buildStyle
    class DockerBuild,DockerPush buildStyle
    class DeployDev,DeployProd deployStyle
    class HealthCheck,SmokeTest,Notify deployStyle
    class Dev,Staging,Prod envStyle
