sequenceDiagram
    %% Data Flow - Form Engine Document Generation
    %% DOCX Generation & PDF Conversion Process

    actor User as üë§ User<br/>(GIANG_VIEN)
    participant Frontend as ‚öõÔ∏è React Frontend
    participant Backend as üè¢ NestJS Backend
    participant FormEngine as üêç Form Engine<br/>(FastAPI)
    participant PythonDocx as üìù python-docx
    participant LibreOffice as üìÑ LibreOffice<br/>(Headless)
    participant Storage as üíæ File Storage

    Note over User,Storage: PHASE 1: DOCX GENERATION (< 5s Target)

    User->>Frontend: 1. Click "T·∫°o bi·ªÉu m·∫´u 1B"
    activate Frontend
    Frontend->>Frontend: 2. Collect form data<br/>(title, budget, timeline, etc.)
    Frontend->>Backend: 3. POST /api/documents/generate<br/>{ proposalId, templateType: "1B", data }
    activate Backend

    Backend->>Backend: 4. Validate request<br/>‚Ä¢ Check permissions (RBAC)<br/>‚Ä¢ Verify proposal state
    Backend->>Backend: 5. Prepare context<br/>‚Ä¢ proposal.title<br/>‚Ä¢ proposal.owner.displayName<br/>‚Ä¢ proposal.faculty.name<br/>‚Ä¢ formData sections

    Backend->>FormEngine: 6. POST /generate-docx<br/>{ templateId: "1b", context: {...} }
    activate FormEngine

    FormEngine->>FormEngine: 7. Validate template exists<br/>templates/1b.docx
    FormEngine->>PythonDocx: 8. Load template<br/>Document('templates/1b.docx')
    activate PythonDocx

    PythonDocx-->>FormEngine: 9. Document object
    deactivate PythonDocx

    FormEngine->>FormEngine: 10. Replace placeholders<br/>‚Ä¢ Find: {{ proposal_title }}<br/>‚Ä¢ Replace: context.title<br/>(Repeat for all fields)

    FormEngine->>PythonDocx: 11. Save document<br/>doc.save(output_path)
    activate PythonDocx
    PythonDocx->>Storage: 12. Write DOCX file<br/>uploads/proposals/xxx/1b.docx
    activate Storage
    Storage-->>PythonDocx: 13. File saved
    deactivate Storage
    deactivate PythonDocx

    FormEngine->>FormEngine: 14. Calculate SHA256 hash<br/>hashlib.sha256(file_content)

    FormEngine-->>Backend: 15. Response: 200 OK<br/>{ filePath, fileName, sha256Hash }
    deactivate FormEngine

    Backend->>Backend: 16. Save metadata to DB<br/>‚Ä¢ documents table<br/>‚Ä¢ document_manifests table

    Backend-->>Frontend: 17. Response: Document created<br/>{ documentId, downloadUrl }
    deactivate Backend

    Frontend-->>User: 18. Show success message<br/>"T·∫°o bi·ªÉu m·∫´u 1B th√†nh c√¥ng"
    deactivate Frontend

    Note over User,Storage: PHASE 2: PDF CONVERSION (< 15s Target)

    User->>Frontend: 19. Click "Xu·∫•t PDF"
    activate Frontend
    Frontend->>Backend: 20. POST /api/documents/:id/convert-to-pdf
    activate Backend

    Backend->>Backend: 21. Verify document exists<br/>‚Ä¢ Check ownership<br/>‚Ä¢ Get DOCX file path

    Backend->>FormEngine: 22. POST /convert-to-pdf<br/>{ docxPath: "uploads/..." }
    activate FormEngine

    FormEngine->>LibreOffice: 23. Execute conversion<br/>soffice --headless --convert-to pdf<br/>--outdir temp/ docx_path
    activate LibreOffice

    LibreOffice->>LibreOffice: 24. Convert DOCX ‚Üí PDF<br/>‚Ä¢ Load DOCX<br/>‚Ä¢ Render to PDF format<br/>‚Ä¢ Apply formatting

    LibreOffice->>Storage: 25. Write PDF file<br/>uploads/proposals/xxx/1b.pdf
    activate Storage
    Storage-->>LibreOffice: 26. File saved
    deactivate Storage
    deactivate LibreOffice

    FormEngine->>FormEngine: 27. Calculate PDF hash<br/>hashlib.sha256(pdf_content)

    FormEngine-->>Backend: 28. Response: 200 OK<br/>{ pdfPath, pdfSize, sha256Hash }
    deactivate FormEngine

    Backend->>Backend: 29. Update document metadata<br/>‚Ä¢ pdfPath<br/>‚Ä¢ pdfHash

    Backend-->>Frontend: 30. Response: PDF ready<br/>{ pdfUrl }
    deactivate Backend

    Frontend-->>User: 31. Download PDF<br/>‚Üí Browser downloads file
    deactivate Frontend

    Note over User,Storage: INTEGRITY VERIFICATION

    User->>Frontend: 32. Click "X√°c th·ª±c t√†i li·ªáu"
    activate Frontend
    Frontend->>Backend: 33. GET /api/documents/:id/verify
    activate Backend

    Backend->>Storage: 34. Read document file
    activate Storage
    Storage-->>Backend: 35. File content
    deactivate Storage

    Backend->>Backend: 36. Calculate current hash<br/>SHA256(file_content)
    Backend->>Backend: 37. Compare with stored hash<br/>IF hash_match ‚Üí VALID<br/>ELSE ‚Üí TAMPERED

    Backend-->>Frontend: 38. Response:<br/>{ verified: true, result: "VALID" }
    deactivate Backend

    Frontend-->>User: 39. Show verification status<br/>"‚úì T√†i li·ªáu h·ª£p l·ªá"
    deactivate Frontend

    Note over User,Storage: 18 Templates: 1B - 18B<br/>Same workflow for all form types
