// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  GIANG_VIEN         // Giảng viên / PI (PROJECT_OWNER)
  QUAN_LY_KHOA       // Quản lý Khoa
  THU_KY_KHOA        // Thư ký Khoa
  PHONG_KHCN         // Phòng KHCN
  THU_KY_HOI_DONG    // Thư ký Hội đồng
  THANH_TRUNG        // Thành viên Hội đồng
  BAN_GIAM_HOC       // Ban Giám học
  HOI_DONG           // Thành viên Hội đồng (legacy, same as THANH_TRUNG)
  BGH                // Ban Giám hiệu (legacy, same as BAN_GIAM_HOC)
  ADMIN              // Quản trị hệ thống
}

enum Permission {
  USER_MANAGE             // Quản lý người dùng
  DEMO_SWITCH_PERSONA     // Demo: Chuyển persona
  DEMO_RESET              // Demo: Reset dữ liệu
  CALENDAR_MANAGE         // Quản lý lịch làm việc
  DASHBOARD_VIEW          // Xem dashboard (Story 11.2)
  AUDIT_VIEW              // Xem audit log
  PROPOSAL_CREATE         // Tạo đề tài mới
  PROPOSAL_EDIT           // Sửa đề tài
  VIEW_EVALUATION_RESULTS  // Xem kết quả đánh giá (GIANG_VIEN Feature)
  EXPORT_PROPOSAL_PDF     // Xuất đề tài ra PDF (GIANG_VIEN Feature)
  FORM_TEMPLATE_IMPORT    // Import biểu mẫu từ Word (ADMIN)
}

// ============================================================
// CORE: Users
// ============================================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  displayName  String    @map("display_name")
  role         UserRole
  facultyId    String?   @map("faculty_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  faculty           Faculty?          @relation(fields: [facultyId], references: [id])
  refreshTokens     RefreshToken[]
  auditEventsAsActor  AuditEvent[]    @relation("AuditActor")
  auditEventsAsActing AuditEvent[]    @relation("AuditActingAs")
  ownedProposals    Proposal[]        @relation("ProposalOwner")
  rejectedProposals Proposal[]        @relation("RejectedBy")
  secretaryCouncils Council[]        @relation("CouncilSecretary")
  councilMemberships CouncilMember[]
  evaluations       Evaluation[]      @relation("EvaluationEvaluator")

  @@map("users")
  @@index([email])
  @@index([facultyId])
}

// ============================================================
// AUTH: Refresh Tokens
// ============================================================

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================================
// RBAC: Role Permissions
// ============================================================

model RolePermission {
  id         String     @id @default(uuid())
  role       UserRole
  permission Permission
  createdAt  DateTime   @default(now()) @map("created_at")

  @@unique([role, permission])
  @@map("role_permissions")
}

// ============================================================
// AUDIT: Audit Events
// ============================================================

model AuditEvent {
  id             String   @id @default(uuid())
  occurredAt     DateTime @default(now()) @map("occurred_at")
  actorUserId    String   @map("actor_user_id")
  actingAsUserId String?  @map("acting_as_user_id")
  action         String   // AuditAction enum values
  entityType     String?  @map("entity_type")
  entityId       String?  @map("entity_id")
  metadata       Json?    @db.JsonB
  ip             String?
  userAgent      String?  @map("user_agent")
  requestId      String?  @map("request_id")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  actorUser      User     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: Restrict)
  actingAsUser   User?    @relation("AuditActingAs", fields: [actingAsUserId], references: [id], onDelete: SetNull)

  @@index([occurredAt])
  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_events")
}

// ============================================================
// WORKFLOW: Proposals
// ============================================================

enum ProjectState {
  DRAFT                     // Black nháp
  FACULTY_REVIEW            // Đang xét duyệt tại Khoa
  SCHOOL_SELECTION_REVIEW   // Đang phân bổ Hội đồng
  OUTLINE_COUNCIL_REVIEW    // Đang xét duyệt bởi Hội đồng
  CHANGES_REQUESTED         // Đã yêu cầu sửa
  APPROVED                  // Đã duyệt
  IN_PROGRESS               // Đang thực hiện
  FACULTY_ACCEPTANCE_REVIEW // Đang nghiệm thu cấp Khoa
  SCHOOL_ACCEPTANCE_REVIEW  // Đang nghiệm thu cấp Trường
  HANDOVER                  // Đã bàn giao
  COMPLETED                 // Đã hoàn thành
  CANCELLED                 // Đã hủy
  REJECTED                  // Đã từ chối
  WITHDRAWN                 // Đã rút
  PAUSED                    // Đã tạm dừng
}

enum WorkflowAction {
  CREATE             // Tạo mới
  SUBMIT             // Nộp
  APPROVE            // Duyệt
  RETURN             // Trả về yêu cầu sửa
  RESUBMIT           // Nộp lại
  START_PROJECT      // Bắt đầu thực hiện (Story 6.1)
  SUBMIT_FACULTY_ACCEPTANCE // Nộp hồ sơ nghiệm thu cấp Khoa (Story 6.2)
  FACULTY_ACCEPT     // Khoa chấp nhận nghiệm thu (Story 6.3)
  FACULTY_REJECT     // Khoa từ chối nghiệm thu (Story 6.3)
  SCHOOL_ACCEPT      // Trường chấp nhận nghiệm thu (Story 6.4)
  SCHOOL_REJECT      // Trường từ chối nghiệm thu (Story 6.4)
  HANDOVER_COMPLETE  // Hoàn thành bàn giao (Story 6.5)
  SUBMIT_ACCEPTANCE  // Nộp nghiệm thu (legacy)
  ACCEPT             // Chấp nhận nghiệm thu (legacy)
  REJECT             // Từ chối (legacy)
  CANCEL             // Hủy
  WITHDRAW           // Rút
  PAUSE              // Tạm dừng
  RESUME             // Tiếp tục
  FINALIZE           // Hoàn tất (đóng dự án)
  ASSIGN_COUNCIL     // Phân bổ hội đồng
  EVALUATION_SUBMITTED // Nộp phiếu đánh giá (Story 5.4)
  // Epic 7: Document actions
  TEMPLATE_UPLOAD    // Upload template (Story 7.2)
  TEMPLATE_ACTIVATE  // Kích hoạt template (Story 7.2)
  TEMPLATE_DELETE    // Xóa template (Story 7.2)
  DOC_GENERATED      // Tạo tài liệu (Story 7.3)
  DOC_DOWNLOADED     // Tải xuống tài liệu (Story 7.3)
  DOC_VERIFIED       // Xác thực tính toàn vẹn (Story 7.3)
  // Epic 8: Bulk Actions & Reports
  BULK_ASSIGN        // Gán holder_user hàng loạt (Story 8.1)
  BULK_REMIND        // Gửi email nhắc hàng loạt (Story 8.2)
  REMIND_SENT        // Email nhắc đã gửi (Story 8.2 - per recipient)
  EXPORT_EXCEL       // Xuất Excel (Story 8.3)
}

model Proposal {
  id              String        @id @default(uuid())
  code            String        @unique // DT-001, DT-002, etc.
  title           String
  state           ProjectState  @default(DRAFT)
  ownerId         String        @map("owner_id")
  facultyId       String        @map("faculty_id")
  councilId       String?       @map("council_id")    // FK to councils (Story 5.2)
  holderUnit      String?       @map("holder_unit")  // Faculty ID or "PKHCN" or "COUNCIL-XXX"
  holderUser      String?       @map("holder_user")  // User ID (optional)
  slaStartDate    DateTime?     @map("sla_start_date")
  slaDeadline     DateTime?     @map("sla_deadline")
  actualStartDate DateTime?     @map("actual_start_date") // Story 6.1: Set when starting project
  completedDate   DateTime?     @map("completed_date")   // Story 6.5: Set when completing project
  templateId      String?       @map("template_id")   // FK to form_templates (Story 2.2)
  templateVersion String?       @map("template_version") // e.g., "v1.0" (Story 2.2)
  formData        Json?         @map("form_data")     // JSON with section data (Story 2.2)

  // Epic 9: Exception tracking fields
  cancelledAt     DateTime?     @map("cancelled_at")   // Story 9.1: When proposal was cancelled
  withdrawnAt     DateTime?     @map("withdrawn_at")   // Story 9.1: When proposal was withdrawn
  rejectedAt      DateTime?     @map("rejected_at")    // Story 9.2: When proposal was rejected
  rejectedById    String?       @map("rejected_by_id") // Story 9.2: Who rejected the proposal
  pausedAt        DateTime?     @map("paused_at")      // Story 9.3: When proposal was paused
  resumedAt       DateTime?     @map("resumed_at")     // Story 9.3: When proposal was resumed
  pauseReason     String?       @map("pause_reason")   @db.Text // Story 9.3: Reason for pausing
  expectedResumeAt DateTime?     @map("expected_resume_at") // Story 9.3: Expected resume date
  prePauseState   ProjectState? @map("pre_pause_state") // Story 9.3: State before pausing
  prePauseHolderUnit String?    @map("pre_pause_holder_unit") // Story 9.3: Holder before pausing
  prePauseHolderUser String?    @map("pre_pause_holder_user") // Story 9.3: Holder user before pausing

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")    // Soft delete (Story 2.6)

  owner           User          @relation("ProposalOwner", fields: [ownerId], references: [id])
  faculty         Faculty       @relation(fields: [facultyId], references: [id])
  council         Council?      @relation(fields: [councilId], references: [id])
  template        FormTemplate? @relation(fields: [templateId], references: [id])
  rejectedByUser  User?         @relation("RejectedBy", fields: [rejectedById], references: [id])
  workflowLogs    WorkflowLog[]
  attachments     Attachment[]
  evaluations     Evaluation[]
  documents       Document[]

  @@map("proposals")
  @@index([state])
  @@index([ownerId])
  @@index([facultyId])
  @@index([councilId])         // Story 5.2: index for council queries
  @@index([holderUnit])
  @@index([holderUser])      // Story 2.6: index for holder_user queries
  @@index([slaDeadline])     // Story 2.6: index for SLA queries
  @@index([deletedAt])       // Story 2.6: index for soft delete filter
  @@index([code])
  @@index([templateId])
  @@index([cancelledAt])     // Story 9.1: index for cancelled proposals
  @@index([withdrawnAt])     // Story 9.1: index for withdrawn proposals
  @@index([rejectedAt])      // Story 9.2: index for rejected proposals
  @@index([rejectedById])    // Story 9.2: index for rejected by queries
  @@index([pausedAt])        // Story 9.3: index for paused proposals
  @@index([resumedAt])       // Story 9.3: index for resumed proposals
  @@index([expectedResumeAt]) // Story 9.3: index for expected resume date
}

model WorkflowLog {
  id                      String        @id @default(uuid())
  proposalId              String        @map("proposal_id")
  action                  WorkflowAction
  fromState               ProjectState? @map("from_state")
  toState                 ProjectState  @map("to_state")
  actorId                 String        @map("actor_id")
  actorName               String        @map("actor_name")
  returnTargetState       ProjectState? @map("return_target_state")
  returnTargetHolderUnit  String?       @map("return_target_holder_unit")
  reasonCode              String?       @map("reason_code")
  comment                 String?
  timestamp               DateTime      @default(now())

  proposal                Proposal      @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@map("workflow_logs")
  @@index([proposalId])
  @@index([timestamp])
}

// ============================================================
// ORGANIZATION: Faculties
// ============================================================

enum FacultyType {
  FACULTY     // Khoa
  DEPARTMENT  // Bộ môn/Phòng
}

model Faculty {
  id          String       @id @default(uuid())
  code        String       @unique // FAC-001, FAC-002, etc.
  name        String       // "Khoa CNTT", "Khoa Kinh tế", etc.
  type        FacultyType  @default(FACULTY)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  users       User[]
  proposals   Proposal[]

  @@map("faculties")
  @@index([code])
}

// ============================================================
// FORMS: Form Templates
// ============================================================

enum SectionId {
  // Phase A: Proposal Forms (MAU_01B - MAU_07B)
  SEC_INFO_GENERAL          // Thông tin chung
  SEC_CONTENT_METHOD        // Nội dung nghiên cứu
  SEC_RESEARCH_METHOD       // Phương pháp nghiên cứu
  SEC_EXPECTED_RESULTS      // Kết quả mong đợi
  SEC_BUDGET                // Kinh phí
  SEC_ATTACHMENTS           // Tài liệu đính kèm
  SEC_RESEARCHERS           // Đội ngũ nghiên cứu
  SEC_FACILITIES            // Cơ sở vật chất
  SEC_TIMELINE              // Kế hoạch thời gian
  SEC_REFERENCES            // Tài liệu tham khảo

  // Phase C: Faculty Acceptance (MAU_08B - MAU_11B)
  SEC_FACULTY_ACCEPTANCE_RESULTS   // Kết quả nghiên cứu
  SEC_FACULTY_ACCEPTANCE_PRODUCTS  // Sản phẩm nghiên cứu

  // Phase D: School Acceptance (MAU_12B - MAU_16B)
  SEC_SCHOOL_ACCEPTANCE_RESULTS   // Kết quả nghiên cứu
  SEC_SCHOOL_ACCEPTANCE_PRODUCTS  // Sản phẩm nghiên cứu

  // Phase E: Handover (MAU_17B)
  SEC_HANDOVER_CHECKLIST   // Checklist bàn giao

  // Phase B: Extension (MAU_18B)
  SEC_EXTENSION_REASON     // Lý do gia hạn
  SEC_EXTENSION_DURATION   // Thời gian gia hạn

  // Add new sections here, never modify existing IDs
}

model FormTemplate {
  id          String        @id @default(uuid())
  code        String        @unique // MAU_01B, MAU_02B, etc.
  name        String        // Vietnamese name
  version     String        @default("v1.0")
  description String?       @db.Text
  isActive    Boolean       @default(true) @map("is_active")
  projectType String        @default("CAP_TRUONG") @map("project_type") // MVP: hardcoded
  sections    FormSection[]
  proposals   Proposal[]    // Reverse relation from Proposal (Story 2.2)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@map("form_templates")
  @@index([code])
  @@index([isActive])
}

model FormSection {
  id           String    @id @default(uuid())
  templateId   String    @map("template_id")
  sectionId    SectionId @map("section_id")
  label        String    // Vietnamese display label
  component    String    // React component name
  displayOrder Int       @map("display_order")
  isRequired   Boolean   @default(false) @map("is_required")
  config       Json?     @db.JsonB // Additional config (options, validation rules, etc.)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  template     FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, sectionId])
  @@index([templateId])
  @@map("form_sections")
}

// ============================================================
// CALENDAR: Business Calendar
// ============================================================

model BusinessCalendar {
  id            String    @id @default(uuid())
  date          DateTime  @db.Date
  name          String
  isHoliday     Boolean   @default(true) @map("is_holiday")
  isWorkingDay  Boolean   @default(false) @map("is_working_day") // For compensatory days
  recurring     Boolean   @default(false) // Yearly recurring
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([date])
  @@map("business_calendar")
  @@index([date])
}

// ============================================================
// COUNCILS: Council Management (Story 5.2)
// ============================================================

enum CouncilType {
  OUTLINE           // Hội đồng xét duyệt đề cương
  ACCEPTANCE        // Hội đồng nghiệm thu
  EXTENSION         // Hội đồng gia hạn
}

enum CouncilMemberRole {
  CHAIR             // Chủ tịch hội đồng
  SECRETARY         // Thư ký
  MEMBER            // Thành viên
}

model Council {
  id           String        @id @default(uuid())
  name         String        // "Hội đồng khoa CNTT #1"
  type         CouncilType   // OUTLINE, ACCEPTANCE, etc.
  secretaryId  String?       @map("secretary_id")
  secretary    User?         @relation("CouncilSecretary", fields: [secretaryId], references: [id])
  members      CouncilMember[]
  proposals    Proposal[]
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  @@map("councils")
  @@index([type])
}

model CouncilMember {
  id         String        @id @default(uuid())
  councilId  String        @map("council_id")
  council    Council       @relation(fields: [councilId], references: [id], onDelete: Cascade)
  userId     String        @map("user_id")
  user       User          @relation(fields: [userId], references: [id])
  role       CouncilMemberRole // CHAIR, SECRETARY, MEMBER
  createdAt  DateTime      @default(now()) @map("created_at")

  @@unique([councilId, userId])
  @@index([councilId])
  @@index([userId])
  @@map("council_members")
}

// ============================================================
// DOCUMENT TEMPLATES: DOCX Template Management (Epic 7 Story 7.2)
// ============================================================

enum DocumentTemplateType {
  PROPOSAL_OUTLINE       // Đề cương đề tài
  EVALUATION_FORM        // Phiếu đánh giá
  FINAL_REPORT           // Báo cáo cuối cùng
  FACULTY_ACCEPTANCE     // Biên bản nghiệm thu cấp Khoa
  SCHOOL_ACCEPTANCE      // Biên bản nghiệm thu cấp Trường
  HANDOVER_CHECKLIST     // Biên bản bàn giao
}

model DocumentTemplate {
  id            String                  @id @default(uuid())
  name          String
  description   String?                 @db.Text
  templateType  DocumentTemplateType    @map("template_type")
  filePath      String                  @map("file_path")
  fileName      String                  @map("file_name")
  fileSize      Int                     @map("file_size")
  sha256Hash    String                  @map("sha256_hash")
  version       Int                     @default(1) // For tracking template versions
  placeholders  String[]                // Array of placeholder names extracted from template
  isActive      Boolean                 @default(false) @map("is_active")
  createdBy     String                  @map("created_by")
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")
  deletedAt     DateTime?               @map("deleted_at")

  documents     Document[]

  @@unique([templateType, isActive])
  @@index([templateType])
  @@index([isActive])
  @@index([deletedAt])
  @@map("document_templates")
}

// ============================================================
// DOCUMENTS: Generated Documents (Epic 7 Story 7.3)
// ============================================================

enum DocumentType {
  PROPOSAL_OUTLINE       // Đề cương đề tài
  EVALUATION_FORM        // Phiếu đánh giá
  FINAL_REPORT           // Báo cáo cuối cùng
  FACULTY_ACCEPTANCE     // Biên bản nghiệm thu cấp Khoa
  SCHOOL_ACCEPTANCE      // Biên bản nghiệm thu cấp Trường
  HANDOVER_CHECKLIST     // Biên bản bàn giao
}

model Document {
  id              String         @id @default(uuid())
  proposalId      String         @map("proposal_id")
  documentType    DocumentType   @map("document_type")
  templateId      String         @map("template_id")
  templateVersion Int            @map("template_version")
  filePath        String         @map("file_path")
  fileName        String         @map("file_name")
  fileSize        Int            @map("file_size")
  sha256Hash      String         @unique @map("sha256_hash")
  generatedBy     String         @map("generated_by")
  generatedAt     DateTime       @default(now()) @map("generated_at")
  deletedAt       DateTime?      @map("deleted_at")
  retentionUntil  DateTime?      @map("retention_until") // 7 years retention

  proposal        Proposal       @relation(fields: [proposalId], references: [id])
  template        DocumentTemplate @relation(fields: [templateId], references: [id])
  manifest        DocumentManifest?

  @@index([proposalId])
  @@index([sha256Hash])
  @@index([deletedAt])
  @@index([generatedAt])
  @@map("documents")
}

// ============================================================
// DOCUMENT MANIFESTS: Integrity Tracking (Epic 7 Story 7.3)
// ============================================================

model DocumentManifest {
  id                String   @id @default(uuid())
  documentId        String   @unique @map("document_id")
  templateId        String   @map("template_id")
  templateVersion   Int      @map("template_version")
  proposalData      Json     @map("proposal_data") // Snapshot of proposal data at generation time
  generatedBy       String   @map("generated_by")
  generatedAt       DateTime @default(now()) @map("generated_at")
  verifiedAt        DateTime? @map("verified_at")
  verifiedBy        String?  @map("verified_by")
  verificationResult String? @map("verification_result") // 'VALID' | 'MISMATCH'

  document          Document @relation(fields: [documentId], references: [id])

  @@index([documentId])
  @@map("document_manifests")
}

// ============================================================
// EVALUATIONS: Council Evaluation (Story 5.3)
// ============================================================

enum EvaluationState {
  DRAFT      // Đang soạn thảo
  FINALIZED  // Đã hoàn tất (sau khi finalize - Story 5.4)
}

model Evaluation {
  id          String         @id @default(uuid())
  proposalId  String         @map("proposal_id")
  proposal    Proposal       @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  evaluatorId String         @map("evaluator_id")
  evaluator   User           @relation("EvaluationEvaluator", fields: [evaluatorId], references: [id])
  state       EvaluationState @default(DRAFT)
  formData    Json           @map("form_data")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  @@unique([proposalId, evaluatorId])
  @@index([proposalId])
  @@index([evaluatorId])
  @@index([state])
  @@map("evaluations")
}

// ============================================================
// ATTACHMENTS: Proposal Attachments (Story 2.4)
// ============================================================

model Attachment {
  id          String    @id @default(uuid())
  proposalId  String    @map("proposal_id")
  fileName    String    @map("file_name")
  fileUrl     String    @map("file_url")
  fileSize    Int       @map("file_size")     // in bytes
  mimeType    String    @map("mime_type")
  type        String    @default("GENERAL") @map("type") // GENERAL, FACULTY_ACCEPTANCE, SCHOOL_ACCEPTANCE, HANDOVER (Story 6.2)
  uploadedBy  String    @map("uploaded_by")
  uploadedAt  DateTime  @default(now()) @map("uploaded_at")
  deletedAt   DateTime? @map("deleted_at")

  proposal    Proposal  @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@map("attachments")
  @@index([proposalId])
  @@index([uploadedBy])
  @@index([deletedAt])
  @@index([type])  // Story 6.2: Index for attachment type filtering
}
