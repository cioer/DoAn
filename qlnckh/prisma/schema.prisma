generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// MODELS WITH CAMELCASE NAMES AND @map() DIRECTIVES
// ============================================================

model Attachment {
  id         String    @id
  proposalId String    @map("proposal_id")
  fileName   String    @map("file_name")
  fileUrl    String    @map("file_url")
  fileSize   Int       @map("file_size")
  mimeType   String    @map("mime_type")
  type       String    @default("GENERAL")
  uploadedBy String    @map("uploaded_by")
  uploadedAt DateTime  @default(now()) @map("uploaded_at")
  deletedAt  DateTime? @map("deleted_at")
  proposal   Proposal  @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@index([proposalId])
  @@index([type])
  @@index([uploadedBy])
  @@map("attachments")
}

model AuditEvent {
  id            String   @id
  occurredAt    DateTime @default(now()) @map("occurred_at")
  actorUserId   String   @map("actor_user_id")
  actingAsUserId String? @map("acting_as_user_id")
  action        String
  entityType    String?  @map("entity_type")
  entityId      String?  @map("entity_id")
  metadata      Json?
  ip            String?
  userAgent     String?  @map("user_agent")
  requestId     String?  @map("request_id")
  createdAt     DateTime @default(now()) @map("created_at")
  actingAsUser  User?    @relation("AuditActingAs", fields: [actingAsUserId], references: [id])
  actorUser     User     @relation("AuditActor", fields: [actorUserId], references: [id])

  @@index([action])
  @@index([actorUserId])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([occurredAt])
  @@map("audit_events")
}

model BusinessCalendar {
  id          String   @id @default(uuid())
  date        DateTime @unique @db.Date
  name        String
  isHoliday   Boolean  @default(true) @map("is_holiday")
  isWorkingDay Boolean @default(false) @map("is_working_day")
  recurring   Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([date])
  @@map("business_calendar")
}

model CouncilMember {
  id        String            @id @default(uuid())
  councilId String            @map("council_id")
  userId    String            @map("user_id")
  role      CouncilMemberRole
  createdAt DateTime          @default(now()) @map("created_at")
  isAuthor  Boolean           @default(false) @map("is_author")
  council   Council           @relation(fields: [councilId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id])

  @@unique([councilId, userId])
  @@index([councilId])
  @@index([isAuthor])
  @@index([userId])
  @@map("council_members")
}

model Council {
  id          String          @id @default(uuid())
  name        String
  type        CouncilType
  scope       CouncilScope    @default(SCHOOL)
  facultyId   String?         @map("faculty_id")
  secretaryId String?         @map("secretary_id")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  members     CouncilMember[]
  faculty     Faculty?        @relation(fields: [facultyId], references: [id])
  secretary   User?           @relation("CouncilSecretary", fields: [secretaryId], references: [id])
  proposals   Proposal[]

  @@index([type])
  @@index([scope])
  @@index([facultyId])
  @@map("councils")
}

model DocumentManifest {
  id                 String    @id @default(uuid())
  documentId         String    @unique @map("document_id")
  templateId         String    @map("template_id")
  templateVersion    Int       @map("template_version")
  proposalData       Json      @map("proposal_data")
  generatedBy        String    @map("generated_by")
  generatedAt        DateTime  @default(now()) @map("generated_at")
  verifiedAt         DateTime? @map("verified_at")
  verifiedBy         String?   @map("verified_by")
  verificationResult String?   @map("verification_result")
  document           Document  @relation(fields: [documentId], references: [id])

  @@index([documentId])
  @@map("document_manifests")
}

model DocumentTemplate {
  id           String               @id @default(uuid())
  name         String
  description  String?
  templateType DocumentTemplateType @map("template_type")
  filePath     String               @map("file_path")
  fileName     String               @map("file_name")
  fileSize     Int                  @map("file_size")
  sha256Hash   String               @map("sha256_hash")
  version      Int                  @default(1)
  placeholders String[]
  isActive     Boolean              @default(false) @map("is_active")
  createdBy    String               @map("created_by")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  deletedAt    DateTime?            @map("deleted_at")
  documents    Document[]

  @@unique([templateType, isActive])
  @@index([deletedAt])
  @@index([isActive])
  @@index([templateType])
  @@map("document_templates")
}

model Document {
  id              String            @id @default(uuid())
  proposalId      String            @map("proposal_id")
  documentType    DocumentType      @map("document_type")
  templateId      String            @map("template_id")
  templateVersion Int               @map("template_version")
  filePath        String            @map("file_path")
  fileName        String            @map("file_name")
  fileSize        Int               @map("file_size")
  sha256Hash      String            @unique @map("sha256_hash")
  generatedBy     String            @map("generated_by")
  generatedAt     DateTime          @default(now()) @map("generated_at")
  deletedAt       DateTime?         @map("deleted_at")
  retentionUntil  DateTime?         @map("retention_until")
  manifest        DocumentManifest?
  proposal        Proposal          @relation(fields: [proposalId], references: [id])
  template        DocumentTemplate  @relation(fields: [templateId], references: [id])

  @@index([deletedAt])
  @@index([generatedAt])
  @@index([proposalId])
  @@index([sha256Hash])
  @@map("documents")
}

model Evaluation {
  id          String          @id @default(uuid())
  proposalId  String          @map("proposal_id")
  evaluatorId String          @map("evaluator_id")
  level       EvaluationLevel @default(SCHOOL)
  state       EvaluationState @default(DRAFT)
  formData    Json            @map("form_data")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  submittedAt DateTime?       @map("submitted_at")
  evaluator   User            @relation(fields: [evaluatorId], references: [id])
  proposal    Proposal        @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, evaluatorId, level])
  @@index([evaluatorId])
  @@index([proposalId])
  @@index([level])
  @@index([state])
  @@map("evaluations")
}

model Faculty {
  id        String      @id @default(uuid())
  code      String      @unique
  name      String
  type      FacultyType @default(FACULTY)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  councils  Council[]
  proposals Proposal[]
  users     User[]

  @@index([code])
  @@map("faculties")
}

model FormSection {
  id           String       @id @default(uuid())
  templateId   String       @map("template_id")
  sectionId    SectionId    @map("section_id")
  label        String
  component    String
  displayOrder Int          @map("display_order")
  isRequired   Boolean      @default(false) @map("is_required")
  config       Json?
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  template     FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, sectionId])
  @@index([templateId])
  @@map("form_sections")
}

model FormTemplate {
  id          String        @id @default(uuid())
  code        String        @unique
  name        String
  version     String        @default("v1.0")
  description String?
  isActive    Boolean       @default(true) @map("is_active")
  projectType String        @default("CAP_TRUONG") @map("project_type")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  sections    FormSection[]
  proposals   Proposal[]

  @@index([code])
  @@index([isActive])
  @@map("form_templates")
}

model ProposalDocument {
  id              String             @id @default(uuid())
  proposalId      String             @map("proposal_id")
  formType        FormType           @map("form_type")
  status          FormDocumentStatus @default(DRAFT)
  version         Int                @default(1)
  filePath        String?            @map("file_path")
  fileName        String?            @map("file_name")
  fileSize        Int?               @map("file_size")
  sha256Hash      String?            @map("sha256_hash")
  formData        Json?              @map("form_data")
  createdBy       String             @map("created_by")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  approvedBy      String?            @map("approved_by")
  approvedAt      DateTime?          @map("approved_at")
  rejectedBy      String?            @map("rejected_by")
  rejectedAt      DateTime?          @map("rejected_at")
  rejectionReason String?            @map("rejection_reason")
  deletedAt       DateTime?          @map("deleted_at")
  proposal        Proposal           @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, formType, version])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([formType])
  @@index([proposalId])
  @@index([status])
  @@map("proposal_documents")
}

model Proposal {
  id                 String             @id @default(uuid())
  code               String             @unique
  title              String
  state              ProjectState       @default(DRAFT)
  ownerId            String             @map("owner_id")
  facultyId          String             @map("faculty_id")
  councilId          String?            @map("council_id")
  holderUnit         String?            @map("holder_unit")
  holderUser         String?            @map("holder_user")
  slaStartDate       DateTime?          @map("sla_start_date")
  slaDeadline        DateTime?          @map("sla_deadline")
  actualStartDate    DateTime?          @map("actual_start_date")
  completedDate      DateTime?          @map("completed_date")
  templateId         String?            @map("template_id")
  templateVersion    String?            @map("template_version")
  formData           Json?              @map("form_data")
  cancelledAt        DateTime?          @map("cancelled_at")
  withdrawnAt        DateTime?          @map("withdrawn_at")
  rejectedAt         DateTime?          @map("rejected_at")
  rejectedById       String?            @map("rejected_by_id")
  pausedAt           DateTime?          @map("paused_at")
  resumedAt          DateTime?          @map("resumed_at")
  pauseReason        String?            @map("pause_reason")
  expectedResumeAt   DateTime?          @map("expected_resume_at")
  prePauseState      ProjectState?      @map("pre_pause_state")
  prePauseHolderUnit String?            @map("pre_pause_holder_unit")
  prePauseHolderUser String?            @map("pre_pause_holder_user")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  deletedAt          DateTime?          @map("deleted_at")
  attachments        Attachment[]
  documents          Document[]
  evaluations        Evaluation[]
  proposalDocuments  ProposalDocument[]
  council            Council?           @relation(fields: [councilId], references: [id])
  faculty            Faculty            @relation(fields: [facultyId], references: [id])
  owner              User               @relation("ProposalOwner", fields: [ownerId], references: [id])
  rejectedBy         User?              @relation("RejectedBy", fields: [rejectedById], references: [id])
  template           FormTemplate?      @relation(fields: [templateId], references: [id])
  workflowLogs       WorkflowLog[]

  @@index([cancelledAt])
  @@index([code])
  @@index([councilId])
  @@index([deletedAt])
  @@index([expectedResumeAt])
  @@index([facultyId])
  @@index([holderUnit])
  @@index([holderUser])
  @@index([ownerId])
  @@index([pausedAt])
  @@index([rejectedAt])
  @@index([rejectedById])
  @@index([resumedAt])
  @@index([slaDeadline])
  @@index([state])
  @@index([templateId])
  @@index([withdrawnAt])
  @@map("proposals")
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String    @map("user_id")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

model RolePermission {
  id         String     @id @default(uuid())
  role       UserRole
  permission Permission
  createdAt  DateTime   @default(now()) @map("created_at")

  @@unique([role, permission])
  @@map("role_permissions")
}

model User {
  id                String          @id @default(uuid())
  email             String          @unique
  passwordHash      String          @map("password_hash")
  displayName       String          @map("display_name")
  role              UserRole
  facultyId         String?         @map("faculty_id")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  deletedAt         DateTime?       @map("deleted_at")
  auditEventsAsActing AuditEvent[]  @relation("AuditActingAs")
  auditEventsAsActor  AuditEvent[]  @relation("AuditActor")
  councilMemberships  CouncilMember[]
  secretaryCouncils   Council[]     @relation("CouncilSecretary")
  evaluations         Evaluation[]
  ownedProposals      Proposal[]    @relation("ProposalOwner")
  rejectedProposals   Proposal[]    @relation("RejectedBy")
  refreshTokens       RefreshToken[]
  faculty             Faculty?      @relation(fields: [facultyId], references: [id])

  @@index([email])
  @@index([facultyId])
  @@map("users")
}

model WorkflowLog {
  id                    String        @id @default(uuid())
  proposalId            String        @map("proposal_id")
  action                WorkflowAction
  fromState             ProjectState? @map("from_state")
  toState               ProjectState  @map("to_state")
  actorId               String        @map("actor_id")
  actorName             String        @map("actor_name")
  returnTargetState     ProjectState? @map("return_target_state")
  returnTargetHolderUnit String?      @map("return_target_holder_unit")
  reasonCode            String?       @map("reason_code")
  comment               String?
  timestamp             DateTime      @default(now())
  proposal              Proposal      @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([timestamp])
  @@map("workflow_logs")
}

// ============================================================
// ENUMS
// ============================================================

enum CouncilMemberRole {
  CHAIR
  SECRETARY
  MEMBER
}

enum CouncilScope {
  FACULTY
  SCHOOL
}

enum CouncilType {
  FACULTY_OUTLINE
  SCHOOL_OUTLINE
  FACULTY_ACCEPTANCE
  SCHOOL_ACCEPTANCE
}

enum DocumentTemplateType {
  PROPOSAL_OUTLINE
  EVALUATION_FORM
  FINAL_REPORT
  FACULTY_ACCEPTANCE
  SCHOOL_ACCEPTANCE
  HANDOVER_CHECKLIST
}

enum DocumentType {
  PROPOSAL_OUTLINE
  EVALUATION_FORM
  FINAL_REPORT
  FACULTY_ACCEPTANCE
  SCHOOL_ACCEPTANCE
  HANDOVER_CHECKLIST
}

enum EvaluationLevel {
  FACULTY
  SCHOOL
}

enum EvaluationState {
  DRAFT
  SUBMITTED
  FINALIZED
}

enum FacultyType {
  FACULTY
  DEPARTMENT
}

enum FormDocumentStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  FINALIZED
}

enum FormType {
  FORM_1B
  FORM_PL1
  FORM_2B
  FORM_3B
  FORM_4B
  FORM_5B
  FORM_6B
  FORM_7B
  FORM_8B
  FORM_9B
  FORM_10B
  FORM_11B
  FORM_PL2
  FORM_12B
  FORM_13B
  FORM_14B
  FORM_15B
  FORM_16B
  FORM_PL3
  FORM_17B
  FORM_18B
}

enum Permission {
  USER_MANAGE
  DEMO_SWITCH_PERSONA
  DEMO_RESET
  CALENDAR_MANAGE
  DASHBOARD_VIEW
  AUDIT_VIEW
  PROPOSAL_CREATE
  PROPOSAL_EDIT
  VIEW_EVALUATION_RESULTS
  EXPORT_PROPOSAL_PDF
  FORM_TEMPLATE_IMPORT
  FACULTY_APPROVE
  FACULTY_RETURN
  PROPOSAL_VIEW_FACULTY
  FACULTY_DASHBOARD_VIEW
  FACULTY_USER_MANAGE
}

enum ProjectState {
  DRAFT
  FACULTY_COUNCIL_OUTLINE_REVIEW
  SCHOOL_COUNCIL_OUTLINE_REVIEW
  CHANGES_REQUESTED
  APPROVED
  IN_PROGRESS
  FACULTY_COUNCIL_ACCEPTANCE_REVIEW
  SCHOOL_COUNCIL_ACCEPTANCE_REVIEW
  HANDOVER
  COMPLETED
  CANCELLED
  REJECTED
  WITHDRAWN
  PAUSED
}

enum SectionId {
  SEC_INFO_GENERAL
  SEC_CONTENT_METHOD
  SEC_RESEARCH_METHOD
  SEC_EXPECTED_RESULTS
  SEC_BUDGET
  SEC_ATTACHMENTS
  SEC_RESEARCHERS
  SEC_FACILITIES
  SEC_TIMELINE
  SEC_REFERENCES
  SEC_FACULTY_ACCEPTANCE_RESULTS
  SEC_FACULTY_ACCEPTANCE_PRODUCTS
  SEC_SCHOOL_ACCEPTANCE_RESULTS
  SEC_SCHOOL_ACCEPTANCE_PRODUCTS
  SEC_HANDOVER_CHECKLIST
  SEC_EXTENSION_REASON
  SEC_EXTENSION_DURATION
}

enum UserRole {
  GIANG_VIEN
  QUAN_LY_KHOA
  THU_KY_KHOA
  PHONG_KHCN
  BAN_GIAM_HOC
  ADMIN
}

enum WorkflowAction {
  CREATE
  SUBMIT
  APPROVE
  RETURN
  RESUBMIT
  START_PROJECT
  SUBMIT_FACULTY_ACCEPTANCE
  FACULTY_ACCEPT
  FACULTY_REJECT
  SCHOOL_ACCEPT
  SCHOOL_REJECT
  HANDOVER_COMPLETE
  SUBMIT_ACCEPTANCE
  ACCEPT
  REJECT
  CANCEL
  WITHDRAW
  PAUSE
  RESUME
  FINALIZE
  ASSIGN_COUNCIL
  EVALUATION_SUBMITTED
  TEMPLATE_UPLOAD
  TEMPLATE_ACTIVATE
  TEMPLATE_DELETE
  DOC_GENERATED
  DOC_DOWNLOADED
  DOC_VERIFIED
  BULK_ASSIGN
  BULK_REMIND
  REMIND_SENT
  EXPORT_EXCEL
}
