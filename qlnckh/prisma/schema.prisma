generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model attachments {
  id          String    @id
  proposal_id String
  file_name   String
  file_url    String
  file_size   Int
  mime_type   String
  type        String    @default("GENERAL")
  uploaded_by String
  uploaded_at DateTime  @default(now())
  deleted_at  DateTime?
  proposals   proposals @relation(fields: [proposal_id], references: [id], onDelete: Cascade)

  @@index([deleted_at])
  @@index([proposal_id])
  @@index([type])
  @@index([uploaded_by])
}

model audit_events {
  id                                          String   @id
  occurred_at                                 DateTime @default(now())
  actor_user_id                               String
  acting_as_user_id                           String?
  action                                      String
  entity_type                                 String?
  entity_id                                   String?
  metadata                                    Json?
  ip                                          String?
  user_agent                                  String?
  request_id                                  String?
  created_at                                  DateTime @default(now())
  users_audit_events_acting_as_user_idTousers users?   @relation("audit_events_acting_as_user_idTousers", fields: [acting_as_user_id], references: [id])
  users_audit_events_actor_user_idTousers     users    @relation("audit_events_actor_user_idTousers", fields: [actor_user_id], references: [id])

  @@index([action])
  @@index([actor_user_id])
  @@index([created_at])
  @@index([entity_type, entity_id])
  @@index([occurred_at])
}

model business_calendar {
  id             String   @id
  date           DateTime @unique @db.Date
  name           String
  is_holiday     Boolean  @default(true)
  is_working_day Boolean  @default(false)
  recurring      Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime

  @@index([date])
}

model council_members {
  id         String            @id
  council_id String
  user_id    String
  role       CouncilMemberRole
  created_at DateTime          @default(now())
  is_author  Boolean           @default(false)
  councils   councils          @relation(fields: [council_id], references: [id], onDelete: Cascade)
  users      users             @relation(fields: [user_id], references: [id])

  @@unique([council_id, user_id])
  @@index([council_id])
  @@index([is_author])
  @@index([user_id])
}

model councils {
  id              String            @id
  name            String
  type            CouncilType
  secretary_id    String?
  created_at      DateTime          @default(now())
  updated_at      DateTime
  council_members council_members[]
  users           users?            @relation(fields: [secretary_id], references: [id])
  proposals       proposals[]

  @@index([type])
}

model document_manifests {
  id                  String    @id
  document_id         String    @unique
  template_id         String
  template_version    Int
  proposal_data       Json
  generated_by        String
  generated_at        DateTime  @default(now())
  verified_at         DateTime?
  verified_by         String?
  verification_result String?
  documents           documents @relation(fields: [document_id], references: [id])

  @@index([document_id])
}

model document_templates {
  id            String               @id
  name          String
  description   String?
  template_type DocumentTemplateType
  file_path     String
  file_name     String
  file_size     Int
  sha256_hash   String
  version       Int                  @default(1)
  placeholders  String[]
  is_active     Boolean              @default(false)
  created_by    String
  created_at    DateTime             @default(now())
  updated_at    DateTime
  deleted_at    DateTime?
  documents     documents[]

  @@unique([template_type, is_active])
  @@index([deleted_at])
  @@index([is_active])
  @@index([template_type])
}

model documents {
  id                 String              @id
  proposal_id        String
  document_type      DocumentType
  template_id        String
  template_version   Int
  file_path          String
  file_name          String
  file_size          Int
  sha256_hash        String              @unique
  generated_by       String
  generated_at       DateTime            @default(now())
  deleted_at         DateTime?
  retention_until    DateTime?
  document_manifests document_manifests?
  proposals          proposals           @relation(fields: [proposal_id], references: [id])
  document_templates document_templates  @relation(fields: [template_id], references: [id])

  @@index([deleted_at])
  @@index([generated_at])
  @@index([proposal_id])
  @@index([sha256_hash])
}

model evaluations {
  id           String          @id
  proposal_id  String
  evaluator_id String
  state        EvaluationState @default(DRAFT)
  form_data    Json
  created_at   DateTime        @default(now())
  updated_at   DateTime
  users        users           @relation(fields: [evaluator_id], references: [id])
  proposals    proposals       @relation(fields: [proposal_id], references: [id], onDelete: Cascade)

  @@unique([proposal_id, evaluator_id])
  @@index([evaluator_id])
  @@index([proposal_id])
  @@index([state])
}

model faculties {
  id         String      @id
  code       String      @unique
  name       String
  type       FacultyType @default(FACULTY)
  created_at DateTime    @default(now())
  updated_at DateTime
  proposals  proposals[]
  users      users[]

  @@index([code])
}

model form_sections {
  id             String         @id
  template_id    String
  section_id     SectionId
  label          String
  component      String
  display_order  Int
  is_required    Boolean        @default(false)
  config         Json?
  created_at     DateTime       @default(now())
  updated_at     DateTime
  form_templates form_templates @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@unique([template_id, section_id])
  @@index([template_id])
}

model form_templates {
  id            String          @id
  code          String          @unique
  name          String
  version       String          @default("v1.0")
  description   String?
  is_active     Boolean         @default(true)
  project_type  String          @default("CAP_TRUONG")
  created_at    DateTime        @default(now())
  updated_at    DateTime
  form_sections form_sections[]
  proposals     proposals[]

  @@index([code])
  @@index([is_active])
}

model proposal_documents {
  id               String             @id
  proposal_id      String
  form_type        FormType
  status           FormDocumentStatus @default(DRAFT)
  version          Int                @default(1)
  file_path        String?
  file_name        String?
  file_size        Int?
  sha256_hash      String?
  form_data        Json?
  created_by       String
  created_at       DateTime           @default(now())
  updated_at       DateTime
  approved_by      String?
  approved_at      DateTime?
  rejected_by      String?
  rejected_at      DateTime?
  rejection_reason String?
  deleted_at       DateTime?
  proposals        proposals          @relation(fields: [proposal_id], references: [id], onDelete: Cascade)

  @@unique([proposal_id, form_type, version])
  @@index([created_at])
  @@index([deleted_at])
  @@index([form_type])
  @@index([proposal_id])
  @@index([status])
}

model proposals {
  id                                    String               @id
  code                                  String               @unique
  title                                 String
  state                                 ProjectState         @default(DRAFT)
  owner_id                              String
  faculty_id                            String
  council_id                            String?
  holder_unit                           String?
  holder_user                           String?
  sla_start_date                        DateTime?
  sla_deadline                          DateTime?
  actual_start_date                     DateTime?
  completed_date                        DateTime?
  template_id                           String?
  template_version                      String?
  form_data                             Json?
  cancelled_at                          DateTime?
  withdrawn_at                          DateTime?
  rejected_at                           DateTime?
  rejected_by_id                        String?
  paused_at                             DateTime?
  resumed_at                            DateTime?
  pause_reason                          String?
  expected_resume_at                    DateTime?
  pre_pause_state                       ProjectState?
  pre_pause_holder_unit                 String?
  pre_pause_holder_user                 String?
  created_at                            DateTime             @default(now())
  updated_at                            DateTime
  deleted_at                            DateTime?
  attachments                           attachments[]
  documents                             documents[]
  evaluations                           evaluations[]
  proposal_documents                    proposal_documents[]
  councils                              councils?            @relation(fields: [council_id], references: [id])
  faculties                             faculties            @relation(fields: [faculty_id], references: [id])
  users_proposals_owner_idTousers       users                @relation("proposals_owner_idTousers", fields: [owner_id], references: [id])
  users_proposals_rejected_by_idTousers users?               @relation("proposals_rejected_by_idTousers", fields: [rejected_by_id], references: [id])
  form_templates                        form_templates?      @relation(fields: [template_id], references: [id])
  workflow_logs                         workflow_logs[]

  @@index([cancelled_at])
  @@index([code])
  @@index([council_id])
  @@index([deleted_at])
  @@index([expected_resume_at])
  @@index([faculty_id])
  @@index([holder_unit])
  @@index([holder_user])
  @@index([owner_id])
  @@index([paused_at])
  @@index([rejected_at])
  @@index([rejected_by_id])
  @@index([resumed_at])
  @@index([sla_deadline])
  @@index([state])
  @@index([template_id])
  @@index([withdrawn_at])
}

model refresh_tokens {
  id         String    @id
  token      String    @unique
  user_id    String
  expires_at DateTime
  created_at DateTime  @default(now())
  revoked_at DateTime?
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([user_id])
}

model role_permissions {
  id         String     @id
  role       UserRole
  permission Permission
  created_at DateTime   @default(now())

  @@unique([role, permission])
}

model users {
  id                                                 String            @id
  email                                              String            @unique
  password_hash                                      String
  display_name                                       String
  role                                               UserRole
  faculty_id                                         String?
  created_at                                         DateTime          @default(now())
  updated_at                                         DateTime
  deleted_at                                         DateTime?
  audit_events_audit_events_acting_as_user_idTousers audit_events[]    @relation("audit_events_acting_as_user_idTousers")
  audit_events_audit_events_actor_user_idTousers     audit_events[]    @relation("audit_events_actor_user_idTousers")
  council_members                                    council_members[]
  councils                                           councils[]
  evaluations                                        evaluations[]
  proposals_proposals_owner_idTousers                proposals[]       @relation("proposals_owner_idTousers")
  proposals_proposals_rejected_by_idTousers          proposals[]       @relation("proposals_rejected_by_idTousers")
  refresh_tokens                                     refresh_tokens[]
  faculties                                          faculties?        @relation(fields: [faculty_id], references: [id])

  @@index([email])
  @@index([faculty_id])
}

model workflow_logs {
  id                        String         @id
  proposal_id               String
  action                    WorkflowAction
  from_state                ProjectState?
  to_state                  ProjectState
  actor_id                  String
  actor_name                String
  return_target_state       ProjectState?
  return_target_holder_unit String?
  reason_code               String?
  comment                   String?
  timestamp                 DateTime       @default(now())
  proposals                 proposals      @relation(fields: [proposal_id], references: [id], onDelete: Cascade)

  @@index([proposal_id])
  @@index([timestamp])
}

enum CouncilMemberRole {
  CHAIR
  SECRETARY
  MEMBER
}

enum CouncilType {
  FACULTY_OUTLINE
  SCHOOL_OUTLINE
  FACULTY_ACCEPTANCE
  SCHOOL_ACCEPTANCE
}

enum DocumentTemplateType {
  PROPOSAL_OUTLINE
  EVALUATION_FORM
  FINAL_REPORT
  FACULTY_ACCEPTANCE
  SCHOOL_ACCEPTANCE
  HANDOVER_CHECKLIST
}

enum DocumentType {
  PROPOSAL_OUTLINE
  EVALUATION_FORM
  FINAL_REPORT
  FACULTY_ACCEPTANCE
  SCHOOL_ACCEPTANCE
  HANDOVER_CHECKLIST
}

enum EvaluationState {
  DRAFT
  FINALIZED
}

enum FacultyType {
  FACULTY
  DEPARTMENT
}

enum FormDocumentStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  FINALIZED
}

enum FormType {
  FORM_1B
  FORM_PL1
  FORM_2B
  FORM_3B
  FORM_4B
  FORM_5B
  FORM_6B
  FORM_7B
  FORM_8B
  FORM_9B
  FORM_10B
  FORM_11B
  FORM_PL2
  FORM_12B
  FORM_13B
  FORM_14B
  FORM_15B
  FORM_16B
  FORM_PL3
  FORM_17B
  FORM_18B
}

enum Permission {
  USER_MANAGE
  DEMO_SWITCH_PERSONA
  DEMO_RESET
  CALENDAR_MANAGE
  DASHBOARD_VIEW
  AUDIT_VIEW
  PROPOSAL_CREATE
  PROPOSAL_EDIT
  VIEW_EVALUATION_RESULTS
  EXPORT_PROPOSAL_PDF
  FORM_TEMPLATE_IMPORT
  FACULTY_APPROVE
  FACULTY_RETURN
  PROPOSAL_VIEW_FACULTY
  FACULTY_DASHBOARD_VIEW
  FACULTY_USER_MANAGE
}

enum ProjectState {
  DRAFT
  FACULTY_COUNCIL_OUTLINE_REVIEW
  SCHOOL_COUNCIL_OUTLINE_REVIEW
  CHANGES_REQUESTED
  APPROVED
  IN_PROGRESS
  FACULTY_COUNCIL_ACCEPTANCE_REVIEW
  SCHOOL_COUNCIL_ACCEPTANCE_REVIEW
  HANDOVER
  COMPLETED
  CANCELLED
  REJECTED
  WITHDRAWN
  PAUSED
}

enum SectionId {
  SEC_INFO_GENERAL
  SEC_CONTENT_METHOD
  SEC_RESEARCH_METHOD
  SEC_EXPECTED_RESULTS
  SEC_BUDGET
  SEC_ATTACHMENTS
  SEC_RESEARCHERS
  SEC_FACILITIES
  SEC_TIMELINE
  SEC_REFERENCES
  SEC_FACULTY_ACCEPTANCE_RESULTS
  SEC_FACULTY_ACCEPTANCE_PRODUCTS
  SEC_SCHOOL_ACCEPTANCE_RESULTS
  SEC_SCHOOL_ACCEPTANCE_PRODUCTS
  SEC_HANDOVER_CHECKLIST
  SEC_EXTENSION_REASON
  SEC_EXTENSION_DURATION
}

enum UserRole {
  GIANG_VIEN
  QUAN_LY_KHOA
  THU_KY_KHOA
  PHONG_KHCN
  BAN_GIAM_HOC
  ADMIN
}

enum WorkflowAction {
  CREATE
  SUBMIT
  APPROVE
  RETURN
  RESUBMIT
  START_PROJECT
  SUBMIT_FACULTY_ACCEPTANCE
  FACULTY_ACCEPT
  FACULTY_REJECT
  SCHOOL_ACCEPT
  SCHOOL_REJECT
  HANDOVER_COMPLETE
  SUBMIT_ACCEPTANCE
  ACCEPT
  REJECT
  CANCEL
  WITHDRAW
  PAUSE
  RESUME
  FINALIZE
  ASSIGN_COUNCIL
  EVALUATION_SUBMITTED
  TEMPLATE_UPLOAD
  TEMPLATE_ACTIVATE
  TEMPLATE_DELETE
  DOC_GENERATED
  DOC_DOWNLOADED
  DOC_VERIFIED
  BULK_ASSIGN
  BULK_REMIND
  REMIND_SENT
  EXPORT_EXCEL
}
